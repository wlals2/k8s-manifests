apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: web
  namespace: blog-system
  labels:
    app: web
    tier: frontend
spec:
  replicas: 2
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: web
  # Canary 배포 전략
  strategy:
    canary:
      # Istio 트래픽 라우팅 설정
      trafficRouting:
        istio:
          virtualService:
            name: web-vsvc # VirtualService 이름
            routes:
              - primary # VirtualService의 route 이름
          destinationRule:
            name: web-dest-rule # DestinationRule 이름
            canarySubsetName: canary # canary subset 이름
            stableSubsetName: stable # stable subset 이름
      # Canary 배포 단계 (트래픽 가중치)
      steps:
        - setWeight: 10 # 1단계: Canary 10%, Stable 90%
        - pause:
            duration: 30s # 30초 대기
        - setWeight: 50 # 2단계: Canary 50%, Stable 50%
        - pause:
            duration: 30s
        - setWeight: 90 # 3단계: Canary 90%, Stable 10%
        - pause:
            duration: 30s
        - setWeight: 100 # 4단계: Canary 100% (완료)
  template:
    metadata:
      labels:
        app: web
        tier: frontend
    spec:
      containers:
        - name: nginx
          image: ghcr.io/wlals2/blog-web:v26
          imagePullPolicy: Always
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
      volumes:
        - name: nginx-config
          configMap:
            name: web-nginx-config
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: web
