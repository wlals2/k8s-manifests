# ==============================================================================
# HorizontalPodAutoscaler for blog-system
# ==============================================================================
# 목적: 트래픽 증가 시 자동 Pod 증설
#
# 멀티 메트릭 스케일링 (OR 조건):
# - CPU 사용률: 70% (WAS) / 60% (WEB)
# - Network Receive Rate: 100 KB/s (WAS) / 300 KB/s (WEB)
# → 둘 중 하나라도 임계값 초과 시 스케일 아웃
#
# 최소/최대 Replicas:
# - WAS: 2-10개
# - WEB: 2-5개
#
# VPA 통합:
# - VPA updateMode: Auto → requests 자동 조정
# - HPA는 CPU % + Pods 메트릭 → VPA와 충돌 없음
# ==============================================================================

---
# ==============================================================================
# WAS HPA
# ==============================================================================
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: was-hpa
  namespace: blog-system
  labels:
    app: was
    tier: backend
spec:
  scaleTargetRef:
    apiVersion: argoproj.io/v1alpha1  # Argo Rollout
    kind: Rollout
    name: was

  minReplicas: 2
  maxReplicas: 10

  metrics:
  # Metric 1: CPU 사용률
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # 70% 초과 시 스케일 아웃

  # Metric 2: Network Receive Rate (Custom Metric)
  - type: Pods
    pods:
      metric:
        name: container_network_receive_bytes_per_second
      target:
        type: AverageValue
        averageValue: 100k  # 100 KB/s 초과 시 스케일 아웃

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 5분 대기 후 스케일 인
      policies:
      - type: Percent
        value: 50  # 한 번에 최대 50%까지 줄임
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60  # 1분 대기 후 스케일 아웃
      policies:
      - type: Percent
        value: 100  # 한 번에 최대 100%까지 늘림 (2배)
        periodSeconds: 60

---
# ==============================================================================
# WEB HPA
# ==============================================================================
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: web-hpa
  namespace: blog-system
  labels:
    app: web
    tier: frontend
spec:
  scaleTargetRef:
    apiVersion: argoproj.io/v1alpha1  # Argo Rollout
    kind: Rollout
    name: web

  minReplicas: 2
  maxReplicas: 5

  metrics:
  # Metric 1: CPU 사용률
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60  # 60% 초과 시 스케일 아웃

  # Metric 2: Network Receive Rate (Custom Metric)
  - type: Pods
    pods:
      metric:
        name: container_network_receive_bytes_per_second
      target:
        type: AverageValue
        averageValue: 300k  # 300 KB/s 초과 시 스케일 아웃

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 5분 대기 후 스케일 인
      policies:
      - type: Percent
        value: 50  # 한 번에 최대 50%까지 줄임
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60  # 1분 대기 후 스케일 아웃
      policies:
      - type: Percent
        value: 100  # 한 번에 최대 100%까지 늘림 (2배)
        periodSeconds: 60
