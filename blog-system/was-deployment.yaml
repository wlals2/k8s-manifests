# ==============================================================================
# Spring Boot WAS Deployment
# ==============================================================================
# 목적: Spring Boot 게시판 애플리케이션을 Pod로 배포
#
# 주요 설정:
# - replicas: 1 (단일 Pod, MySQL 단일 연결)
# - imagePullPolicy: Always (GHCR에서 최신 이미지 pull)
# - resources: CPU 250m/500m, Memory 512Mi/1Gi
# - livenessProbe/readinessProbe: /actuator/health (60초 대기)
# - 환경변수: ConfigMap + Secret
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: was
  namespace: blog-system
  labels:
    app: was
    tier: backend
spec:
  replicas: 2  # 고가용성 (2개 Pod, Worker 노드 분산)
  selector:
    matchLabels:
      app: was
  template:
    metadata:
      labels:
        app: was
        tier: backend
    spec:
      containers:
      - name: spring-boot
        image: ghcr.io/wlals2/board-was:v1  # GHCR 이미지 (나중에 push)
        imagePullPolicy: Always  # 항상 최신 이미지 pull
        ports:
        - containerPort: 8080
          name: http

        # 환경변수 주입 (ConfigMap + Secret)
        env:
        # ConfigMap에서 가져오기
        - name: SPRING_DATASOURCE_URL
          valueFrom:
            configMapKeyRef:
              name: was-config
              key: SPRING_DATASOURCE_URL

        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            configMapKeyRef:
              name: was-config
              key: SPRING_DATASOURCE_USERNAME

        # Secret에서 가져오기 (MySQL Secret, Phase 3에서 생성)
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-root-password

        # 리소스 제한
        resources:
          requests:
            cpu: 250m      # 0.25 Core 보장
            memory: 512Mi  # 512MB 보장
          limits:
            cpu: 500m      # 최대 0.5 Core
            memory: 1Gi    # 최대 1GB

        # Liveness Probe (Pod가 살아있는가?)
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60  # Spring Boot 시작 대기 (60초)
          periodSeconds: 10         # 10초마다 체크
          timeoutSeconds: 5         # 5초 타임아웃
          failureThreshold: 3       # 3번 실패 시 Pod 재시작

        # Readiness Probe (트래픽 받을 준비됐나?)
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 50   # Spring Boot 시작 대기 (50초)
          periodSeconds: 5          # 5초마다 체크
          timeoutSeconds: 3         # 3초 타임아웃
          failureThreshold: 2       # 2번 실패 시 Service에서 제외

      # 멀티 노드 분산 (로컬 환경용)
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: was
