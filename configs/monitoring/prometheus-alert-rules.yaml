# ==============================================================================
# Prometheus Alert Rules
# ==============================================================================
# ëª©ì : ì‹œìŠ¤í…œ ì¥ì•  ë° ì´ìƒ ìƒíƒœ ê°ì§€í•˜ì—¬ AlertManagerë¡œ ì•ŒëŒ ì „ì†¡
#
# ì ìš© ë°©ë²•:
# 1. kubectl apply -f prometheus-alert-rules.yaml
# 2. Prometheusê°€ ìë™ìœ¼ë¡œ rules ë¡œë“œ (rule_files: '/etc/prometheus/rules/*.yml')
# 3. AlertManagerê°€ Telegramìœ¼ë¡œ ì•ŒëŒ ì „ì†¡
# ==============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alert-rules
  namespace: monitoring
  labels:
    app: prometheus
data:
  alert-rules.yml: |
    groups:
      # ==============================================================================
      # ğŸ”¥ CRITICAL Alerts - ì¦‰ì‹œ í™•ì¸ í•„ìš”
      # ==============================================================================
      - name: critical_alerts
        interval: 15s  # 15ì´ˆë§ˆë‹¤ í‰ê°€
        rules:
          # âœ¨ ë¸”ë¡œê·¸ ì‚¬ì´íŠ¸ ë‹¤ìš´ (ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€) - ê°€ì¥ ì¤‘ìš”!
          - alert: BlogWebsiteDown
            expr: probe_success{job="blackbox-http", instance="http://blog.jiminhome.shop"} == 0
            for: 1m  # 1ë¶„ ë™ì•ˆ ì§€ì†ë˜ë©´ ì•ŒëŒ
            labels:
              severity: critical
              namespace: blog-system
            annotations:
              summary: "ë¸”ë¡œê·¸ ì‚¬ì´íŠ¸ ì ‘ì† ë¶ˆê°€"
              description: "blog.jiminhome.shopì— ì™¸ë¶€ì—ì„œ ì ‘ì†í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”!"

          # MySQL ì„œë¹„ìŠ¤ ë‹¤ìš´
          - alert: MySQLDown
            expr: mysql_up{namespace="blog-system"} == 0
            for: 1m
            labels:
              severity: critical
              namespace: blog-system
            annotations:
              summary: "MySQL ì„œë¹„ìŠ¤ ë‹¤ìš´"
              description: "MySQL ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”!"

          # Pod CrashLoopBackOff
          - alert: PodCrashLooping
            expr: rate(kube_pod_container_status_restarts_total{namespace="blog-system"}[15m]) > 0.1
            for: 5m
            labels:
              severity: critical
              namespace: blog-system
            annotations:
              summary: "Podê°€ ë°˜ë³µì ìœ¼ë¡œ ì¬ì‹œì‘ë©ë‹ˆë‹¤"
              description: "{{ $labels.pod }} Podê°€ CrashLoopBackOff ìƒíƒœì…ë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."

          # ë…¸ë“œ ë‹¤ìš´
          - alert: NodeDown
            expr: up{job="kubernetes-nodes"} == 0
            for: 3m
            labels:
              severity: critical
              namespace: kube-system
            annotations:
              summary: "Kubernetes ë…¸ë“œ ë‹¤ìš´"
              description: "{{ $labels.instance }} ë…¸ë“œê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."

      # ==============================================================================
      # âš ï¸ WARNING Alerts - ì£¼ì˜ í•„ìš”
      # ==============================================================================
      - name: warning_alerts
        interval: 30s
        rules:
          # ë””ìŠ¤í¬ ì‚¬ìš©ë¥  85% ì´ìƒ
          - alert: HighDiskUsage
            expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 15
            for: 5m
            labels:
              severity: warning
              namespace: monitoring
            annotations:
              summary: "ë””ìŠ¤í¬ ì‚¬ìš©ë¥  85% ì´ˆê³¼"
              description: "{{ $labels.instance }}ì˜ {{ $labels.mountpoint }} ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ 85%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

          # CPU ì‚¬ìš©ë¥  80% ì´ìƒ
          - alert: HighCPUUsage
            expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 10m
            labels:
              severity: warning
              namespace: monitoring
            annotations:
              summary: "CPU ì‚¬ìš©ë¥  80% ì´ˆê³¼"
              description: "{{ $labels.instance }}ì˜ CPU ì‚¬ìš©ë¥ ì´ 10ë¶„ ë™ì•ˆ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

          # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  85% ì´ìƒ
          - alert: HighMemoryUsage
            expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
            for: 5m
            labels:
              severity: warning
              namespace: monitoring
            annotations:
              summary: "ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  85% ì´ˆê³¼"
              description: "{{ $labels.instance }}ì˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ 85%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

          # Pod Not Ready
          - alert: PodNotReady
            expr: kube_pod_status_ready{condition="false", namespace="blog-system"} == 1
            for: 10m
            labels:
              severity: warning
              namespace: blog-system
            annotations:
              summary: "Pod Not Ready ìƒíƒœ"
              description: "{{ $labels.pod }} Podê°€ 10ë¶„ ë™ì•ˆ Ready ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."

          # Kiali, Grafana, Prometheus ë‹¤ìš´
          - alert: MonitoringToolDown
            expr: up{job=~"kiali|grafana|prometheus"} == 0
            for: 5m
            labels:
              severity: warning
              namespace: monitoring
            annotations:
              summary: "ëª¨ë‹ˆí„°ë§ ë„êµ¬ ë‹¤ìš´"
              description: "{{ $labels.job }} ì„œë¹„ìŠ¤ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          # âœ¨ ìƒˆë¡œ ì¶”ê°€: MySQL Connection ì‚¬ìš©ë¥  70% ì´ìƒ
          - alert: MySQLHighConnectionUsage
            expr: (mysql_global_status_threads_connected{namespace="blog-system"} / mysql_global_variables_max_connections{namespace="blog-system"}) * 100 > 70
            for: 5m
            labels:
              severity: warning
              namespace: blog-system
            annotations:
              summary: "MySQL Connection ì‚¬ìš©ë¥  70% ì´ˆê³¼"
              description: "MySQL Connection ì‚¬ìš©ë¥ ì´ {{ $value | humanize }}%ì…ë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”!"


      # ==============================================================================
      # â„¹ï¸ INFO Alerts - ì •ë³´ì„± ì•ŒëŒ
      # ==============================================================================
      - name: info_alerts
        interval: 1m
        rules:
          # HPA ìŠ¤ì¼€ì¼ ì´ë²¤íŠ¸
          - alert: HPAScaled
            expr: changes(kube_horizontalpodautoscaler_status_current_replicas{namespace="blog-system"}[5m]) > 0
            for: 1m
            labels:
              severity: info
              namespace: blog-system
            annotations:
              summary: "HPA ìŠ¤ì¼€ì¼ ì´ë²¤íŠ¸"
              description: "{{ $labels.horizontalpodautoscaler }}ê°€ ìŠ¤ì¼€ì¼ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ Replica: {{ $value }}"

          # ğŸ§ª Discord í†µí•© í…ŒìŠ¤íŠ¸ ì•ŒëŒ (ì„ì‹œ)
          - alert: DiscordIntegrationTest
            expr: vector(1)  # í•­ìƒ true (ì¦‰ì‹œ ë°œìƒ)
            for: 0s          # ëŒ€ê¸° ì‹œê°„ ì—†ìŒ
            labels:
              severity: info
              namespace: monitoring
            annotations:
              summary: "Discord í†µí•© í…ŒìŠ¤íŠ¸"
              description: "Prometheus â†’ AlertManager â†’ Discord ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ ë©”ì‹œì§€ê°€ ë³´ì´ë©´ ì•ŒëŒ ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤."

          # ArgoCD ë°°í¬ ì™„ë£Œ
          # (ArgoCD Prometheus metricsê°€ ìˆì„ ê²½ìš°)
