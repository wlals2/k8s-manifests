apiVersion: v1
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
                - alertmanager:9093

    rule_files:
      - '/etc/prometheus/rules/*.yml'

    scrape_configs:
      # Prometheus 자체 모니터링
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      # Grafana Alloy - 로그 + 시스템 메트릭 통합 (Promtail + node-exporter 대체)
      - job_name: 'alloy'
        metrics_path: '/api/v0/component/prometheus.exporter.unix.system/metrics'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - monitoring
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: alloy
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: instance
          - source_labels: [__address__]
            target_label: __address__
            regex: '([^:]+)(?::\d+)?'
            replacement: '${1}:12345'

      # 시스템 메트릭 (CPU, 메모리, 디스크) - DaemonSet이므로 서비스 디스커버리 사용
      - job_name: 'node-exporter'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - monitoring
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: node-exporter
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: instance
          - source_labels: [__address__]
            target_label: __address__
            regex: '([^:]+)(?::\d+)?'
            replacement: '${1}:9100'

      # Docker/K8s 컨테이너 메트릭 - DaemonSet
      - job_name: 'cadvisor'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - monitoring
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: cadvisor
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: instance
          - source_labels: [__address__]
            target_label: __address__
            regex: '([^:]+)(?::\d+)?'
            replacement: '${1}:8080'

      # 빌드 프로세스 모니터링
      - job_name: 'pushgateway'
        honor_labels: true
        static_configs:
          - targets: ['pushgateway:9091']

      # Nginx 블로그 모니터링
      - job_name: 'nginx-exporter'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - monitoring
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: nginx-exporter
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: instance
          - source_labels: [__address__]
            target_label: __address__
            regex: '([^:]+)(?::\d+)?'
            replacement: '${1}:9113'

      # MySQL Exporter (NEW)
      - job_name: 'mysql-exporter'
        static_configs:
          - targets: ['mysql-exporter.blog-system.svc.cluster.local:9104']
            labels:
              instance: mysql
              namespace: blog-system

      # Kube State Metrics (NEW)
      - job_name: 'kube-state-metrics'
        static_configs:
          - targets: ['kube-state-metrics.monitoring.svc.cluster.local:8080']

      # Kubernetes API Server
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
          - role: endpoints
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
            action: keep
            regex: default;kubernetes;https

      # Kubernetes Nodes
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)

      # Kubernetes cAdvisor (컨테이너 메트릭 with namespace/pod labels)
      - job_name: 'kubernetes-cadvisor'
        kubernetes_sd_configs:
          - role: node
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
        metric_relabel_configs:
          # namespace 레이블을 kubernetes_namespace로 복사
          - source_labels: [namespace]
            target_label: kubernetes_namespace
            action: replace
          # pod 레이블을 kubernetes_pod_name으로 복사
          - source_labels: [pod]
            target_label: kubernetes_pod_name
            action: replace

      # Blackbox HTTP Probe - 서비스 가용성 체크
      - job_name: 'blackbox-http'
        metrics_path: /probe
        params:
          module: [http_2xx]
        static_configs:
          - targets:
            - http://blog.jiminhome.shop  # ✨ 외부 접근 (가장 중요! 사용자 관점)
            - http://web-service.blog-system.svc.cluster.local
            - http://was-service.blog-system.svc.cluster.local:8080/api/posts
        relabel_configs:
          - source_labels: [__address__]
            target_label: __param_target
          - source_labels: [__param_target]
            target_label: instance
          - target_label: __address__
            replacement: blackbox-exporter:9115
          - target_label: job
            replacement: blackbox-http

      # Blackbox TCP Probe - MySQL Exporter 체크 (mysql-exporter가 이미 MySQL 상태 모니터링)
      - job_name: 'blackbox-tcp'
        metrics_path: /probe
        params:
          module: [http_2xx]
        static_configs:
          - targets:
            - http://mysql-exporter.blog-system.svc.cluster.local:9104/metrics
        relabel_configs:
          - source_labels: [__address__]
            target_label: __param_target
          - source_labels: [__param_target]
            target_label: instance
          - target_label: __address__
            replacement: blackbox-exporter:9115
          - target_label: job
            replacement: blackbox-tcp

      # Kubernetes Pods
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"prometheus.yml":"global:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n            - alertmanager:9093\n\nrule_files:\n  - '/etc/prometheus/rules/*.yml'\n\nscrape_configs:\n  # Prometheus 자체 모니터링\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n\n  # 시스템 메트릭 (CPU, 메모리, 디스크) - DaemonSet이므로 서비스 디스커버리 사용\n  - job_name: 'node-exporter'\n    kubernetes_sd_configs:\n      - role: pod\n        namespaces:\n          names:\n            - monitoring\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n        action: keep\n        regex: node-exporter\n      - source_labels: [__meta_kubernetes_pod_node_name]\n        target_label: instance\n      - source_labels: [__address__]\n        target_label: __address__\n        regex: '([^:]+)(?::\\d+)?'\n        replacement: '${1}:9100'\n\n  # Docker/K8s 컨테이너 메트릭 - DaemonSet\n  - job_name: 'cadvisor'\n    kubernetes_sd_configs:\n      - role: pod\n        namespaces:\n          names:\n            - monitoring\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n        action: keep\n        regex: cadvisor\n      - source_labels: [__meta_kubernetes_pod_node_name]\n        target_label: instance\n      - source_labels: [__address__]\n        target_label: __address__\n        regex: '([^:]+)(?::\\d+)?'\n        replacement: '${1}:8080'\n\n  # 빌드 프로세스 모니터링\n  - job_name: 'pushgateway'\n    honor_labels: true\n    static_configs:\n      - targets: ['pushgateway:9091']\n\n  # Nginx 블로그 모니터링\n  - job_name: 'nginx-exporter'\n    kubernetes_sd_configs:\n      - role: pod\n        namespaces:\n          names:\n            - monitoring\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n        action: keep\n        regex: nginx-exporter\n      - source_labels: [__meta_kubernetes_pod_node_name]\n        target_label: instance\n      - source_labels: [__address__]\n        target_label: __address__\n        regex: '([^:]+)(?::\\d+)?'\n        replacement: '${1}:9113'\n\n  # MySQL Exporter (NEW)\n  - job_name: 'mysql-exporter'\n    static_configs:\n      - targets: ['mysql-exporter.blog-system.svc.cluster.local:9104']\n        labels:\n          instance: mysql\n          namespace: blog-system\n\n  # Kube State Metrics (NEW)\n  - job_name: 'kube-state-metrics'\n    static_configs:\n      - targets: ['kube-state-metrics.monitoring.svc.cluster.local:8080']\n\n  # Kubernetes API Server\n  - job_name: 'kubernetes-apiservers'\n    kubernetes_sd_configs:\n      - role: endpoints\n    scheme: https\n    tls_config:\n      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n        action: keep\n        regex: default;kubernetes;https\n\n  # Kubernetes Nodes\n  - job_name: 'kubernetes-nodes'\n    kubernetes_sd_configs:\n      - role: node\n    scheme: https\n    tls_config:\n      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      insecure_skip_verify: true\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n\n  # Kubernetes cAdvisor (컨테이너 메트릭 with namespace/pod labels)\n  - job_name: 'kubernetes-cadvisor'\n    kubernetes_sd_configs:\n      - role: node\n    scheme: https\n    tls_config:\n      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      insecure_skip_verify: true\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - target_label: __address__\n        replacement: kubernetes.default.svc:443\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\n        target_label: __metrics_path__\n        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n    metric_relabel_configs:\n      # namespace 레이블을 kubernetes_namespace로 복사\n      - source_labels: [namespace]\n        target_label: kubernetes_namespace\n        action: replace\n      # pod 레이블을 kubernetes_pod_name으로 복사\n      - source_labels: [pod]\n        target_label: kubernetes_pod_name\n        action: replace\n\n  # Kubernetes Pods\n  - job_name: 'kubernetes-pods'\n    kubernetes_sd_configs:\n      - role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n        action: replace\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n        target_label: __address__\n      - action: labelmap\n        regex: __meta_kubernetes_pod_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        action: replace\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_pod_name]\n        action: replace\n        target_label: kubernetes_pod_name\n"},"kind":"ConfigMap","metadata":{"annotations":{},"creationTimestamp":"2026-01-20T01:55:01Z","name":"prometheus-config","namespace":"monitoring","resourceVersion":"3793464","uid":"55d45980-0888-428d-9aa6-349ca5e9b4f4"}}
  creationTimestamp: "2026-01-21T03:43:25Z"
  name: prometheus-config
  namespace: monitoring
  resourceVersion: "4189345"
  uid: c6a90537-553c-40d2-a564-53305f36383b
