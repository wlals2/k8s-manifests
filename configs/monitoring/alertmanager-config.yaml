apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      # Discord Webhook (Slack í˜¸í™˜ ëª¨ë“œ)
      slack_api_url: 'https://discordapp.com/api/webhooks/1467150664336408668/L8uFfxn5O8WXLpt99Q1oeWmhp6H9ae8OOb0oUMzmWojIGDuufs-zDbZ2JnrSE7Mm9Ya-/slack'

    route:
      group_by: ['alertname', 'namespace', 'severity']
      group_wait: 30s          # âœ¨ 30ì´ˆ ë™ì•ˆ ëª¨ì•„ì„œ ì „ì†¡
      group_interval: 30s      # âœ¨ ê°™ì€ ê·¸ë£¹ ì•ŒëŒ 30ì´ˆ ê°„ê²©
      repeat_interval: 4h      # âœ¨ 4ì‹œê°„ ë™ì•ˆ ì¤‘ë³µ ë°©ì§€
      receiver: 'discord-homelab'
      routes:
        - match:
            severity: critical
          receiver: 'discord-critical'
        - match:
            severity: warning
          receiver: 'discord-warning'

    receivers:
      # â„¹ï¸ INFO ë ˆë²¨ (ê¸°ë³¸)
      - name: 'discord-homelab'
        slack_configs:
          - channel: '#alerts'  # Discordì—ì„œëŠ” ë¬´ì‹œë¨ (Webhookì´ ì±„ë„ ê²°ì •)
            username: 'Homelab Alert'
            icon_emoji: ':information_source:'
            title: 'â„¹ï¸ [ì •ë³´] {{ .GroupLabels.alertname }}'
            text: |
              **ìš”ì•½:** {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
              **ìƒì„¸:** {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
              **ì‹¬ê°ë„:** {{ .CommonLabels.severity }}
              **ë„¤ì„ìŠ¤í˜ì´ìŠ¤:** {{ .CommonLabels.namespace }}
              **ì‹œì‘:** {{ range .Alerts }}{{ .StartsAt }}{{ end }}
            send_resolved: true

      # ğŸ”¥ CRITICAL ë ˆë²¨
      - name: 'discord-critical'
        slack_configs:
          - channel: '#alerts'
            username: 'Homelab Alert - CRITICAL'
            icon_emoji: ':fire:'
            title: 'ğŸ”¥ [ì‹¬ê°] {{ .GroupLabels.alertname }}'
            color: 'danger'  # ë¹¨ê°„ìƒ‰
            text: |
              **âš ï¸ ì¦‰ì‹œ í™•ì¸ í•„ìš”!**

              **ìš”ì•½:** {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
              **ìƒì„¸:** {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
              **ì‹¬ê°ë„:** {{ .CommonLabels.severity }}
              **ë„¤ì„ìŠ¤í˜ì´ìŠ¤:** {{ .CommonLabels.namespace }}
              **ì‹œì‘:** {{ range .Alerts }}{{ .StartsAt }}{{ end }}

              **Prometheus:** http://prom.jiminhome.shop
            send_resolved: true

      # âš ï¸ WARNING ë ˆë²¨
      - name: 'discord-warning'
        slack_configs:
          - channel: '#alerts'
            username: 'Homelab Alert - Warning'
            icon_emoji: ':warning:'
            title: 'âš ï¸ [ì£¼ì˜] {{ .GroupLabels.alertname }}'
            color: 'warning'  # ì£¼í™©ìƒ‰
            text: |
              **ìš”ì•½:** {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
              **ìƒì„¸:** {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
              **ì‹¬ê°ë„:** {{ .CommonLabels.severity }}
              **ë„¤ì„ìŠ¤í˜ì´ìŠ¤:** {{ .CommonLabels.namespace }}
              **ì‹œì‘:** {{ range .Alerts }}{{ .StartsAt }}{{ end }}
            send_resolved: true

    inhibit_rules:
      # Critical ì•ŒëŒ ë°œìƒ ì‹œ Warning ì•ŒëŒ ì–µì œ
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace']
