# ==============================================================================
# MySQL Alert Rules (PrometheusRule CRD)
# ==============================================================================
# 목적: MySQL 장애 감지 Alert를 Kubernetes-native 방식으로 선언
# 기존 방식: prometheus-alert-rules.yaml의 groups에 수동 추가
# 새로운 방식: PrometheusRule CRD 생성 → Operator가 자동으로 Prometheus Rules 업데이트
# ==============================================================================
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: mysql-alerts
  namespace: monitoring  # PrometheusRule은 monitoring namespace에 생성
  labels:
    # CRITICAL: 이 라벨이 없으면 Prometheus Operator가 무시함!
    # 이유: values.yaml의 ruleSelector.matchLabels와 일치해야 함
    # 확인: apps/kube-prometheus-stack/values.yaml:69
    release: kube-prometheus-stack

    # 추가 라벨 (선택 사항)
    app: mysql-exporter
    component: database
    severity: critical  # Alert 중요도 표시

spec:
  # Alert Rule Groups
  # 이유: 여러 Rule을 논리적으로 그룹화
  # 예: mysql-critical, mysql-warning, mysql-info
  groups:
    # Group 1: Critical Alerts (즉시 조치 필요)
    - name: mysql-critical
      # 평가 간격 (Evaluation Interval)
      # 형식: 30s, 1m, 5m 등
      # 의미: 이 그룹의 Rule을 얼마나 자주 평가할 것인가?
      # 권장: 30s (기본값)
      # Trade-off:
      #   - 짧을수록: 빠른 감지, CPU ↑
      #   - 길수록: 늦은 감지, CPU ↓
      interval: 30s

      # Rules 정의
      rules:
        # Alert 1: MySQL Exporter Down
        - alert: MySQLExporterDown
          # PromQL 표현식
          # 의미: up{job="mysql-exporter"} 메트릭이 0이면 (Exporter 다운)
          # up 메트릭:
          #   - 1: Target이 응답함 (정상)
          #   - 0: Target이 응답 안 함 (다운)
          expr: up{job="mysql-exporter"} == 0

          # 대기 시간 (For Duration)
          # 의미: 이 조건이 1분 동안 지속되면 Alert 발생
          # 이유: 일시적 네트워크 장애 무시 (False Positive 방지)
          # 권장:
          #   - Critical: 1m (빠른 감지)
          #   - Warning: 5m (안정적 감지)
          for: 1m

          # Alert 라벨
          # 이유: AlertManager가 라벨로 Alert 분류/라우팅
          # 예: severity=critical → Telegram 즉시 전송
          #     severity=warning → Email 전송
          labels:
            severity: critical      # 중요도: critical, warning, info
            component: database     # 컴포넌트: database, network, storage 등
            namespace: blog-system  # 영향받는 namespace

          # Alert Annotations (설명 및 추가 정보)
          # 이유: 알림 메시지에 포함될 내용
          # 지원: Go Template 문법 ({{ }})
          annotations:
            summary: "MySQL Exporter가 다운되었습니다"
            description: |
              MySQL Exporter ({{ $labels.instance }})가 1분 동안 응답하지 않습니다.

              **영향**: MySQL 메트릭 수집 중단
              **조치**:
                1. Exporter Pod 상태 확인: kubectl get pods -n blog-system -l app=mysql-exporter
                2. Exporter 로그 확인: kubectl logs -n blog-system -l app=mysql-exporter
                3. MySQL 연결 확인: mysql-exporter가 MySQL에 접속 가능한지 확인

              **현재 값**: {{ $value }} (0 = 다운, 1 = 정상)

        # Alert 2: MySQL High Connections
        - alert: MySQLHighConnections
          # PromQL 표현식
          # 의미: MySQL 연결 수가 최대 연결 수의 80%를 초과
          # mysql_global_status_max_used_connections: 현재 사용 중인 최대 연결 수
          # mysql_global_variables_max_connections: 설정된 최대 연결 수
          expr: |
            (mysql_global_status_max_used_connections / mysql_global_variables_max_connections) > 0.8

          # 대기 시간: 5분 동안 지속되면 Alert
          # 이유: 일시적 트래픽 증가 무시
          for: 5m

          labels:
            severity: warning
            component: database
            namespace: blog-system

          annotations:
            summary: "MySQL 연결 수가 높습니다"
            description: |
              MySQL 연결 수가 최대 연결 수의 80%를 초과했습니다.

              **현재 연결 수**: {{ $value | humanizePercentage }}
              **영향**: 새로운 연결 거부 위험
              **조치**:
                1. max_connections 설정 증가 고려
                2. Connection Pool 설정 확인
                3. 느린 쿼리 확인: SHOW PROCESSLIST

        # Alert 3: MySQL Replication Lag (HA 구성 시)
        - alert: MySQLReplicationLag
          # PromQL 표현식
          # 의미: Replication Lag가 30초 초과
          # mysql_slave_status_seconds_behind_master: Slave가 Master보다 얼마나 뒤처졌는지 (초)
          expr: mysql_slave_status_seconds_behind_master > 30

          # 대기 시간: 2분 동안 지속되면 Alert
          for: 2m

          labels:
            severity: warning
            component: database
            namespace: blog-system

          annotations:
            summary: "MySQL Replication Lag가 높습니다"
            description: |
              MySQL Slave가 Master보다 {{ $value }}초 뒤처졌습니다.

              **영향**: 읽기 데이터 불일치, Failover 시 데이터 손실 위험
              **조치**:
                1. Slave 부하 확인
                2. Network Latency 확인
                3. Binlog 크기 확인

    # Group 2: Warning Alerts (모니터링 필요)
    - name: mysql-warning
      interval: 1m
      rules:
        # Alert 4: MySQL Slow Queries
        - alert: MySQLSlowQueries
          # PromQL 표현식
          # 의미: 느린 쿼리 수가 5분 동안 10개 초과
          # rate(): 초당 증가율 계산
          # [5m]: 5분 동안의 데이터
          expr: rate(mysql_global_status_slow_queries[5m]) > 10

          for: 5m

          labels:
            severity: warning
            component: database
            namespace: blog-system

          annotations:
            summary: "MySQL 느린 쿼리가 증가하고 있습니다"
            description: |
              느린 쿼리가 5분 동안 초당 {{ $value }}개 발생하고 있습니다.

              **영향**: 응답 시간 증가, 서비스 품질 저하
              **조치**:
                1. Slow Query Log 확인
                2. 인덱스 추가 필요 여부 검토
                3. Query Optimization

# ==============================================================================
# 기존 방식 (Raw ConfigMap) vs 새로운 방식 (PrometheusRule)
# ==============================================================================
#
# ❌ 기존 방식 (configs/monitoring/prometheus-alert-rules.yaml):
# ---
# groups:
#   - name: mysql-critical
#     rules:
#       - alert: MySQLDown
#         expr: up{job="mysql-exporter"} == 0
#         for: 1m
#
# 문제점:
#   1. ConfigMap 수동 수정 → ArgoCD OutOfSync
#   2. Prometheus reload 수동 필요
#   3. YAML 문법 오류 시 Prometheus 전체 Rules 로드 실패
#
# ✅ 새로운 방식 (PrometheusRule CRD):
# ---
# apiVersion: monitoring.coreos.com/v1
# kind: PrometheusRule
# metadata:
#   labels:
#     prometheus: kube-prometheus  ← CRITICAL!
# spec:
#   groups:
#     - name: mysql-critical
#       rules:
#         - alert: MySQLDown
#
# 장점:
#   1. Git 커밋 → ArgoCD Sync → Always Synced ✅
#   2. Prometheus 자동 reload (Operator가 처리)
#   3. YAML 문법 오류 → 해당 PrometheusRule만 실패 (다른 Rules 영향 없음)
#   4. Kubernetes-native 방식 (kubectl get prometheusrule)
#   5. Rule별로 독립적 관리 (mysql-alerts.yaml, node-alerts.yaml 분리)
#
# ==============================================================================
# 검증 방법
# ==============================================================================
#
# 1. PrometheusRule 생성 확인
#    kubectl get prometheusrule mysql-alerts -n monitoring
#
# 2. Prometheus가 Rules를 인식했는지 확인
#    kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090
#    브라우저: http://localhost:9090/alerts
#    → "MySQLExporterDown", "MySQLHighConnections" 등 있어야 함
#
# 3. Alert 테스트 (의도적으로 Exporter 다운)
#    kubectl scale deployment mysql-exporter -n blog-system --replicas=0
#    1분 후: MySQLExporterDown Alert Firing 확인
#    kubectl scale deployment mysql-exporter -n blog-system --replicas=1
#
# 4. Alert Rule 파일 확인 (Prometheus 내부)
#    kubectl exec -n monitoring prometheus-kube-prometheus-stack-prometheus-0 \
#      -- cat /etc/prometheus/rules/prometheus-kube-prometheus-stack-prometheus-rulefiles-0/*.yaml
#
# ==============================================================================
# Go Template 문법 참고
# ==============================================================================
#
# {{ $labels.instance }}        # 라벨 값 출력
# {{ $value }}                   # Alert 조건 값 출력 (숫자)
# {{ $value | humanize }}        # 1234567 → "1.234567M"
# {{ $value | humanizePercentage }} # 0.8 → "80%"
# {{ $value | humanizeDuration }}   # 3600 → "1h0m0s"
#
# ==============================================================================
