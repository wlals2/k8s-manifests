---
# ==============================================================================
# Unified Backup to S3 (etcd + MySQL)
# ==============================================================================
# Î™©Ï†Å: etcdÏôÄ MySQLÏùÑ S3Ïóê Î∞±ÏóÖ (7Ïùº Î≥¥Í¥Ä)
#
# ÏÇ¨Ï†Ñ Ï§ÄÎπÑ:
# 1. S3 bucket ÏÉùÏÑ± (Ïòà: my-k8s-backups)
# 2. S3 Lifecycle Ï†ïÏ±Ö Ï†ÅÏö© (7Ïùº ÌõÑ ÏÇ≠Ï†ú)
# 3. aws-s3-credentials Secret Ï°¥Ïû¨ ÌôïÏù∏ (blog-system namespace)
#
# Î∞∞Ìè¨:
# 1. YAMLÏóêÏÑú "YOUR_S3_BUCKET_NAME"ÏùÑ Ïã§Ï†ú bucket Ïù¥Î¶ÑÏúºÎ°ú Î≥ÄÍ≤Ω
# 2. kubectl apply -f backup-to-s3-final.yaml
# 3. ÏàòÎèô ÌÖåÏä§Ìä∏: kubectl create job etcd-backup-test --from=cronjob/etcd-backup-to-s3 -n backup-system
# ==============================================================================

apiVersion: v1
kind: Namespace
metadata:
  name: backup-system
  labels:
    name: backup-system

---
# etcd Backup CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup-to-s3
  namespace: backup-system
  labels:
    app: etcd-backup
spec:
  schedule: "0 2 * * *"  # Îß§Ïùº ÏÉàÎ≤Ω 2Ïãú
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: etcd-backup
        spec:
          hostNetwork: true
          nodeName: k8s-cp  # Control Plane ÎÖ∏ÎìúÏóêÏÑúÎßå Ïã§Ìñâ
          restartPolicy: OnFailure
          containers:
          - name: etcd-backup
            image: amazon/aws-cli:2.15.17
            command:
            - /bin/sh
            - -ec
            - |
              echo "üöÄ etcd Backup to S3 Started"

              # Install etcdctl
              apk add --no-cache etcd-ctl curl

              DATE=$(date +%Y-%m-%d)
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              BACKUP_FILE="/tmp/etcd-snapshot-$TIMESTAMP.db"
              S3_BUCKET="YOUR_S3_BUCKET_NAME"  # ‚Üê Ïó¨Í∏∞Î•º ÏàòÏ†ïÌïòÏÑ∏Ïöî!
              S3_PATH="s3://$S3_BUCKET/etcd/$DATE/snapshot-$TIMESTAMP.db"

              # 1. etcd snapshot ÏÉùÏÑ±
              echo "üì∏ Creating etcd snapshot..."
              ETCDCTL_API=3 etcdctl snapshot save $BACKUP_FILE \
                --endpoints=https://127.0.0.1:2379 \
                --cacert=/etc/kubernetes/pki/etcd/ca.crt \
                --cert=/etc/kubernetes/pki/etcd/server.crt \
                --key=/etc/kubernetes/pki/etcd/server.key

              # 2. Î∞±ÏóÖ Í≤ÄÏ¶ù
              echo "‚úÖ Verifying snapshot..."
              ETCDCTL_API=3 etcdctl snapshot status $BACKUP_FILE -w table

              # 3. S3 ÏóÖÎ°úÎìú
              echo "üì§ Uploading to S3: $S3_PATH"
              aws s3 cp $BACKUP_FILE $S3_PATH \
                --region ${AWS_DEFAULT_REGION} \
                --no-progress

              # 4. ÏóÖÎ°úÎìú Í≤ÄÏ¶ù
              if aws s3 ls $S3_PATH --region ${AWS_DEFAULT_REGION}; then
                echo "‚úÖ Backup completed successfully!"
                echo "   Location: $S3_PATH"
                echo "   Size: $(ls -lh $BACKUP_FILE | awk '{print $5}')"
              else
                echo "‚ùå S3 upload failed!"
                exit 1
              fi

              # 5. Î°úÏª¨ ÌååÏùº Ï†ïÎ¶¨
              rm -f $BACKUP_FILE
            env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-s3-credentials
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-s3-credentials
                  key: AWS_SECRET_ACCESS_KEY
            - name: AWS_DEFAULT_REGION
              valueFrom:
                secretKeyRef:
                  name: aws-s3-credentials
                  key: AWS_DEFAULT_REGION
            volumeMounts:
            - name: etcd-certs
              mountPath: /etc/kubernetes/pki/etcd
              readOnly: true
          volumes:
          - name: etcd-certs
            hostPath:
              path: /etc/kubernetes/pki/etcd
              type: Directory

---
# MySQL Backup CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup-to-s3
  namespace: backup-system
  labels:
    app: mysql-backup
spec:
  schedule: "30 2 * * *"  # Îß§Ïùº ÏÉàÎ≤Ω 2Ïãú 30Î∂Ñ (etcd Î∞±ÏóÖ ÌõÑ)
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: mysql-backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: mysql-backup
            image: amazon/aws-cli:2.15.17
            command:
            - /bin/sh
            - -ec
            - |
              echo "üöÄ MySQL Backup to S3 Started"

              # Install mysql-client and gzip
              apk add --no-cache mysql-client gzip curl

              DATE=$(date +%Y-%m-%d)
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              BACKUP_FILE="/tmp/blog-system-$TIMESTAMP.sql"
              COMPRESSED_FILE="/tmp/blog-system-$TIMESTAMP.sql.gz"
              S3_BUCKET="YOUR_S3_BUCKET_NAME"  # ‚Üê Ïó¨Í∏∞Î•º ÏàòÏ†ïÌïòÏÑ∏Ïöî!
              S3_PATH="s3://$S3_BUCKET/mysql/$DATE/blog-system-$TIMESTAMP.sql.gz"

              # 1. MySQL backup (mysqldump)
              echo "üì∏ Creating MySQL dump..."
              mysqldump -h mysql.blog-system.svc.cluster.local \
                -u root -p${MYSQL_ROOT_PASSWORD} \
                --all-databases \
                --single-transaction \
                --quick \
                --lock-tables=false \
                --routines \
                --triggers \
                --events \
                > $BACKUP_FILE

              # 2. ÏïïÏ∂ï
              echo "üóúÔ∏è Compressing backup..."
              gzip $BACKUP_FILE

              # 3. S3 ÏóÖÎ°úÎìú
              echo "üì§ Uploading to S3: $S3_PATH"
              aws s3 cp $COMPRESSED_FILE $S3_PATH \
                --region ${AWS_DEFAULT_REGION} \
                --no-progress

              # 4. ÏóÖÎ°úÎìú Í≤ÄÏ¶ù
              if aws s3 ls $S3_PATH --region ${AWS_DEFAULT_REGION}; then
                echo "‚úÖ Backup completed successfully!"
                echo "   Location: $S3_PATH"
                echo "   Size: $(ls -lh $COMPRESSED_FILE | awk '{print $5}')"
              else
                echo "‚ùå S3 upload failed!"
                exit 1
              fi

              # 5. Î°úÏª¨ ÌååÏùº Ï†ïÎ¶¨
              rm -f $COMPRESSED_FILE
            env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: mysql-root-password
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-s3-credentials
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-s3-credentials
                  key: AWS_SECRET_ACCESS_KEY
            - name: AWS_DEFAULT_REGION
              valueFrom:
                secretKeyRef:
                  name: aws-s3-credentials
                  key: AWS_DEFAULT_REGION
