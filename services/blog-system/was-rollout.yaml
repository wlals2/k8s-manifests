# ==============================================================================
# Spring Boot WAS Rollout (Canary Deployment)
# ==============================================================================
# 목적: Spring Boot API를 점진적 Canary 배포
#
# 주요 설정:
# - Canary 배포: 20% → 50% → 80% → 100%
# - Istio Traffic Splitting (VirtualService)
# - 각 단계마다 1분 대기 (API 안정성 확인)
# - HPA 연동 (2-10 replicas)
#
# ArgoCD 연동:
# - Git Manifest 업데이트 → ArgoCD Auto-Sync → Canary 배포 시작
# - Rollout Status 확인: kubectl argo rollouts status was -n blog-system
# ==============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: was
  namespace: blog-system
  labels:
    app: was
    tier: backend
spec:
  replicas: 2 # 초기 replicas (HPA가 2-10으로 조정)
  selector:
    matchLabels:
      app: was
  template:
    metadata:
      labels:
        app: was
        tier: backend
      annotations:
        # Istio sidecar 리소스 최적화
        sidecar.istio.io/proxyCPU: "10m"
        sidecar.istio.io/proxyCPULimit: "200m"
        sidecar.istio.io/proxyMemory: "40Mi"
        sidecar.istio.io/proxyMemoryLimit: "128Mi"
    spec:
      # ==============================================================================
      # SecurityContext (보안 강화)
      # ==============================================================================
      # - runAsNonRoot: Root 사용자 실행 금지
      # - runAsUser: 65534 (nobody) 또는 Dockerfile에서 정의한 사용자
      # - fsGroup: 볼륨 마운트 시 그룹 권한
      # ==============================================================================
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      # ==============================================================================
      # Init Container: OpenTelemetry Java Agent 다운로드
      # ==============================================================================
      initContainers:
        - name: otel-agent-download
          image: curlimages/curl:8.5.0
          command:
            - sh
            - -c
            - |
              curl -L -f -o /otel/opentelemetry-javaagent.jar \
                --connect-timeout 30 \
                --max-time 300 \
                --retry 3 \
                --retry-delay 5 \
                https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v1.32.0/opentelemetry-javaagent.jar
              chmod 644 /otel/opentelemetry-javaagent.jar
              echo "OpenTelemetry Java Agent downloaded successfully (size: $(wc -c < /otel/opentelemetry-javaagent.jar) bytes)"
          volumeMounts:
            - name: otel-agent
              mountPath: /otel
          securityContext:
            runAsNonRoot: false
            runAsUser: 0
      containers:
        - name: spring-boot
          image: ghcr.io/wlals2/board-was:v24
          imagePullPolicy: Always
          # Container 레벨 보안 설정
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          ports:
            - containerPort: 8080
              name: http
          # 환경변수 주입 (ConfigMap + Secret + OpenTelemetry)
          env:
            # Spring Boot 데이터소스
            - name: SPRING_DATASOURCE_URL
              valueFrom:
                configMapKeyRef:
                  name: was-config
                  key: SPRING_DATASOURCE_URL
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: was-config
                  key: SPRING_DATASOURCE_USERNAME
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: mysql-root-password
            # GitHub OAuth (Decap CMS)
            - name: GITHUB_OAUTH_CLIENT_ID
              value: "Ov23liUDXOW2o62lb8a3"
            - name: GITHUB_OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: github-oauth-secret
                  key: client-secret
            - name: GITHUB_OAUTH_REDIRECT_URI
              value: "https://blog.jiminhome.shop/auth/callback"
            # OpenTelemetry Java Agent 활성화
            - name: JAVA_TOOL_OPTIONS
              value: "-javaagent:/otel/opentelemetry-javaagent.jar"
            # OTEL 서비스 이름
            - name: OTEL_SERVICE_NAME
              value: "board-was"
            # OTEL Exporter (Tempo)
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://tempo.monitoring.svc.cluster.local:4317"
            - name: OTEL_EXPORTER_OTLP_PROTOCOL
              value: "grpc"
            # OTEL 리소스 속성
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: "service.namespace=blog-system,deployment.environment=production"
            # OTEL 로그 레벨
            - name: OTEL_LOG_LEVEL
              value: "info"
            # 추적 샘플링 (100% 추적)
            - name: OTEL_TRACES_SAMPLER
              value: "always_on"
            # Metrics/Logs는 Prometheus/Loki 사용 (Tempo는 Traces만)
            - name: OTEL_METRICS_EXPORTER
              value: "none"
            - name: OTEL_LOGS_EXPORTER
              value: "none"
          # 리소스 제한
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
          # Startup Probe (초기 시작 시간 확보)
          startupProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 18 # 최대 30 + (10 * 18) = 210초 (3.5분)
          # Liveness Probe (Startup 완료 후 실행)
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          # Readiness Probe
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
          # Volume Mounts
          volumeMounts:
            - name: otel-agent
              mountPath: /otel
              readOnly: true
      # HA: Pod를 여러 노드에 강제 분산 (노드 장애 시 무중단)
      # dynamicStableScale: true 덕분에 DoNotSchedule 사용 가능
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule # hard constraint (HA 보장)
          labelSelector:
            matchLabels:
              app: was
      # Volumes
      volumes:
        - name: otel-agent
          emptyDir: {}
  # ==============================================================================
  # Canary 배포 전략
  # ==============================================================================
  strategy:
    canary:
      # Istio 트래픽 라우팅 사용 시 stable replica를 동적으로 조절
      # → Canary 배포 중에도 총 Pod 수 유지 (HPA 기준)
      # → DoNotSchedule과 함께 사용 가능
      dynamicStableScale: true
      # Canary 배포 단계 (API 안정성 고려)
      steps:
        - setWeight: 20 # 1단계: 20% 트래픽 → Canary
        - pause: {duration: 1m} # 1분 대기 (API 응답 확인)
        - setWeight: 50 # 2단계: 50% 트래픽 → Canary
        - pause: {duration: 1m} # 1분 대기
        - setWeight: 80 # 3단계: 80% 트래픽 → Canary
        - pause: {duration: 1m} # 1분 대기
      # 4단계: 100% → Stable 전환 (자동)

      # Istio Traffic Splitting
      trafficRouting:
        istio:
          virtualService:
            name: was-retry-timeout # WAS VirtualService
            routes:
              - primary # VirtualService의 primary route name
          destinationRule:
            name: was-dest-rule # WAS용 DestinationRule
            canarySubsetName: canary
            stableSubsetName: stable
# 자동 롤백 (추후 AnalysisTemplate 추가 시 사용)
# analysis:
#   templates:
#   - templateName: was-error-rate
#   startingStep: 2  # 2단계(50%)부터 분석 시작
