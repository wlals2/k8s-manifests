# ==============================================================================
# Falco Talon Values (IPS Mode - Pod Isolation)
# ==============================================================================
# 목적: Falco Alert를 받아 자동으로 NetworkPolicy 생성하여 Pod 격리
# 전략: Pod Deletion 대신 Pod Isolation (증거 보존, 서비스 유지)
#
# Phase 1: Dry-Run (현재) - 실제 격리 없이 로그만 기록
# Phase 2: WARNING 격리 (1주 후) - 안전한 레벨부터 시작
# Phase 3: CRITICAL 격리 (2주 후) - 실제 공격 자동 차단

replicaCount: 1

image:
  registry: falco.docker.scarf.sh
  repository: falcosecurity/falco-talon
  tag: latest
  pullPolicy: IfNotPresent

# ==============================================================================
# Talon 설정
# ==============================================================================
config:
  # Falco에서 Alert 수신
  listenAddress: 0.0.0.0
  listenPort: 2803

  # Dry-Run 모드 (Phase 1: 안전한 시작)
  # true: 실제 NetworkPolicy 생성 안 함, 로그만 기록
  # false: 실제 격리 수행
  dryRun: true  # ⚠️ Phase 1: 학습 모드

  # 규칙 정의
  rules:
    # ==================================================================
    # Rule 1: Java RCE 공격 자동 격리 (CRITICAL)
    # ==================================================================
    # 목적: Log4Shell, Spring4Shell 같은 RCE 공격 즉시 차단
    # 동작: Pod에 quarantine 라벨 + NetworkPolicy 생성
    - name: isolate-rce-attack
      match:
        rules:
          - Java Process Spawning Shell
        priority: CRITICAL

      # 예외 조건 (이 조건에 해당하면 격리 안 함)
      exceptions:
        # CI/CD Pod는 제외 (BuildKit 등)
        - namespaces:
            - kube-system
            - monitoring
            - argocd
        # 특정 라벨이 있는 Pod 제외
        - labels:
            ci-cd: "true"

      actions:
        # 1. Pod에 quarantine 라벨 추가
        - action: kubernetes:label
          parameters:
            labels:
              quarantine: "true"
              falco-response: "isolated"
              isolated-reason: "java-rce-detected"
              isolated-at: "{{ .Time }}"

        # 2. NetworkPolicy 생성하여 격리
        - action: kubernetes:networkpolicy
          parameters:
            # DNS 허용 (Pod가 정상 종료될 수 있도록)
            allow_dns: true
            # Monitoring 허용 (Prometheus, Grafana 조사 가능)
            allow_monitoring: true
            # Ingress 모두 차단 (추가 공격 방지)
            deny_all_ingress: true
            # Egress 모두 차단 (C&C 통신, 데이터 유출 방지)
            deny_all_egress: true

    # ==================================================================
    # Rule 2: 패키지 관리자 실행 (WARNING - 알림만)
    # ==================================================================
    # 목적: 컨테이너 불변성 위반 감지
    # 동작: 격리하지 않고 로그만 기록 (False Positive 가능성)
    - name: alert-package-manager
      match:
        rules:
          - Launch Package Management Process in Container
        priority: WARNING

      # WARNING은 격리하지 않음, 로그만
      actions: []

    # ==================================================================
    # Rule 3: 바이너리 디렉토리 쓰기 (ERROR - 알림만)
    # ==================================================================
    # 목적: 악성코드 설치 시도 감지
    # 동작: 초기엔 알림만, 튜닝 후 격리 고려
    - name: alert-binary-write
      match:
        rules:
          - Write to Binary Dir
        priority: ERROR

      # ERROR도 초기엔 격리하지 않음
      actions: []

# ==============================================================================
# RBAC 설정
# ==============================================================================
rbac:
  create: true

serviceAccount:
  create: true
  name: falco-talon

# Talon이 Kubernetes API를 호출하기 위한 권한
clusterRole:
  rules:
    # NetworkPolicy 관리 (격리 핵심 기능)
    - apiGroups: ["networking.k8s.io"]
      resources: ["networkpolicies"]
      verbs: ["create", "get", "list", "delete", "patch"]

    # Pod 라벨 수정 (quarantine 표시)
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list", "patch"]

    # Pod 정보 조회
    - apiGroups: [""]
      resources: ["pods", "namespaces"]
      verbs: ["get", "list"]

    # 이벤트 기록 (감사 로그)
    - apiGroups: [""]
      resources: ["events"]
      verbs: ["create", "patch"]

    # (비활성화) Pod 삭제 권한 - 초기엔 부여 안 함
    # - apiGroups: [""]
    #   resources: ["pods"]
    #   verbs: ["delete"]

# ==============================================================================
# 리소스
# ==============================================================================
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 256Mi

# ==============================================================================
# Service
# ==============================================================================
service:
  type: ClusterIP
  port: 2803
  targetPort: 2803

# ==============================================================================
# 로그 레벨
# ==============================================================================
logLevel: info  # debug, info, warn, error

# ==============================================================================
# Prometheus 메트릭
# ==============================================================================
metrics:
  enabled: true
  port: 2804
  serviceMonitor:
    enabled: false  # Prometheus Operator 사용 시 true

# ==============================================================================
# 주석
# ==============================================================================
# Phase 별 활성화 방법:
#
# Phase 1 (현재): Dry-Run 모드
#   dryRun: true
#   → 실제 NetworkPolicy 생성 안 함, 로그만 기록
#   → 1주일 운영하며 False Positive 패턴 학습
#
# Phase 2 (1주 후): WARNING 격리 활성화
#   dryRun: false
#   alert-package-manager rule에 networkpolicy 액션 추가
#   → 비교적 안전한 WARNING 레벨부터 시작
#
# Phase 3 (2주 후): CRITICAL 격리 활성화
#   dryRun: false (이미 false)
#   isolate-rce-attack rule은 이미 활성화됨
#   → 실제 공격 자동 차단 시작
#
# 격리 해제 방법:
#   kubectl delete networkpolicy quarantine-<pod-name> -n <namespace>
#   kubectl label pod <pod-name> quarantine- falco-response- -n <namespace>
