# DevSecOps ì•„í‚¤í…ì²˜ ë¬¸ì„œ

> MySQL ë°±ì—…, SecurityContext, Network Policy ë“± ë³´ì•ˆ/ìš´ì˜ ê°œì„  ì‚¬í•­ ì •ë¦¬

**ì‘ì„±ì¼**: 2026-01-22
**ë¬¸ì„œ ë²„ì „**: 1.0
**ìƒíƒœ**: âœ… êµ¬í˜„ ì™„ë£Œ

---

## ëª©ì°¨

1. [ê°œìš”](#1-ê°œìš”)
2. [MySQL ë°±ì—… ì•„í‚¤í…ì²˜](#2-mysql-ë°±ì—…-ì•„í‚¤í…ì²˜)
3. [ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (CiliumNetworkPolicy)](#3-ë„¤íŠ¸ì›Œí¬-ë³´ì•ˆ-ciliumnetworkpolicy)
4. [SecurityContext ì„¤ì •](#4-securitycontext-ì„¤ì •)
5. [ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…](#5-ëª¨ë‹ˆí„°ë§-ë°-ë¡œê¹…)
6. [êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸](#6-êµ¬í˜„-ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## 1. ê°œìš”

### 1.1 DevSecOps ëª©í‘œ

| ì˜ì—­ | ëª©í‘œ | ìƒíƒœ |
|------|------|------|
| **ë°ì´í„° ë³´í˜¸** | MySQL ìë™ ë°±ì—… â†’ S3 | âœ… ì™„ë£Œ |
| **ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬** | L3/L4 Zero Trust | âœ… ì™„ë£Œ |
| **ì»¨í…Œì´ë„ˆ ë³´ì•ˆ** | Non-root, Capabilities Drop | âœ… ì™„ë£Œ |
| **ë¡œê·¸ ê´€ë¦¬** | Loki 7ì¼ Retention | âœ… ì™„ë£Œ |

### 1.2 ê¸°ìˆ  ìŠ¤íƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DevSecOps Stack                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Backup       â”‚  MySQL CronJob â†’ AWS S3 (7ì¼ Lifecycle)         â”‚
â”‚  Network      â”‚  Cilium L3/L4 + Istio L7 AuthZ                  â”‚
â”‚  Security     â”‚  SecurityContext, PodSecurityStandards          â”‚
â”‚  Monitoring   â”‚  Prometheus + Grafana + Loki (7ì¼ retention)    â”‚
â”‚  Secrets      â”‚  Kubernetes Secrets (.gitignore)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. MySQL ë°±ì—… ì•„í‚¤í…ì²˜

### 2.1 ì „ì²´ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MySQL Backup Architecture                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  [CronJob: mysql-backup]
         â”‚
         â”‚ ë§¤ì¼ KST 03:00 (UTC 18:00)
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   InitContainer     â”‚
  â”‚   (mysqldump)       â”‚
  â”‚   - mysql:8.0       â”‚
  â”‚   - --all-databases â”‚
  â”‚   - --single-txn    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ gzip ì••ì¶•
            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   emptyDir Volume   â”‚ â”€â”€â–¶ â”‚   Main Container    â”‚
  â”‚   /backup/*.sql.gz  â”‚     â”‚   (aws-cli)         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   - s3 cp           â”‚
                              â”‚   - s3 ls           â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚     AWS S3 Bucket   â”‚
                              â”‚ jimin-mysql-backup  â”‚
                              â”‚                     â”‚
                              â”‚ Lifecycle Policy:   â”‚
                              â”‚ - 7ì¼ í›„ ìë™ ì‚­ì œ  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 CronJob êµ¬ì„±

**íŒŒì¼ ìœ„ì¹˜**: `/home/jimin/k8s-manifests/blog-system/mysql-backup-cronjob.yaml`

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
  namespace: blog-system
spec:
  schedule: "0 18 * * *"  # UTC 18:00 = KST 03:00
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 1800  # 30ë¶„ íƒ€ì„ì•„ì›ƒ
      template:
        metadata:
          labels:
            app: mysql-backup
          annotations:
            sidecar.istio.io/inject: "false"  # Istio ì œì™¸
        spec:
          initContainers:
          - name: mysqldump
            image: mysql:8.0
            # mysqldump â†’ gzip ì••ì¶•
          containers:
          - name: s3-upload
            image: amazon/aws-cli:2.15.0
            # S3 ì—…ë¡œë“œ
          volumes:
          - name: backup-storage
            emptyDir: {}  # Job ì¢…ë£Œ ì‹œ ìë™ ì •ë¦¬
          restartPolicy: OnFailure
```

### 2.3 S3 Lifecycle ì •ì±…

**ë²„í‚·**: `s3://jimin-mysql-backup`
**ë¦¬ì „**: `ap-northeast-2` (ì„œìš¸)

```json
{
  "Rules": [
    {
      "ID": "DeleteOldBackups",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "mysql-backup-"
      },
      "Expiration": {
        "Days": 7
      }
    }
  ]
}
```

**íš¨ê³¼**:
- 7ì¼ ì´ìƒ ëœ ë°±ì—… íŒŒì¼ ìë™ ì‚­ì œ
- ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ìµœì í™”
- ìˆ˜ë™ ê´€ë¦¬ ë¶ˆí•„ìš”

### 2.4 ì™œ emptyDirì„ ì‚¬ìš©í–ˆëŠ”ê°€?

| ì˜µì…˜ | ì¥ì  | ë‹¨ì  | ì„ íƒ |
|------|------|------|------|
| **emptyDir** | PVC ì—†ìŒ, ìŠ¤ì¼€ì¤„ë§ ììœ  | Pod ì¬ì‹œì‘ ì‹œ ì†ì‹¤ | âœ… ì„ íƒ |
| PVC (RWO) | ë°ì´í„° ì˜ì†ì„± | Longhorn attach ë¬¸ì œ | âŒ |
| PVC (RWX) | ë‹¤ì¤‘ ì ‘ê·¼ | NFS ì„±ëŠ¥ ì €í•˜ | âŒ |

**ê²°ë¡ **: S3ê°€ primary storageì´ë¯€ë¡œ emptyDirë¡œ ì¶©ë¶„. Longhorn ë³¼ë¥¨ attach ì´ìŠˆë„ íšŒí”¼.

### 2.5 ë°±ì—… ê²€ì¦

```bash
# 1. ìˆ˜ë™ ë°±ì—… ì‹¤í–‰
kubectl create job --from=cronjob/mysql-backup mysql-backup-manual -n blog-system

# 2. ë¡œê·¸ í™•ì¸
kubectl logs job/mysql-backup-manual -n blog-system --all-containers

# 3. S3 í™•ì¸
aws s3 ls s3://jimin-mysql-backup/

# ì˜ˆìƒ ì¶œë ¥:
# 2026-01-22 12:29:14       1234 mysql-backup-20260122-032914.sql.gz
```

---

## 3. ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (CiliumNetworkPolicy)

### 3.1 ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Network Security Layers                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Layer 7 (L7) - Istio AuthorizationPolicy                   â”‚
  â”‚  - HTTP Method/Path ì œì–´                                     â”‚
  â”‚  - JWT ì¸ì¦                                                  â”‚
  â”‚  - mTLS ì•”í˜¸í™”                                               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Layer 3/4 (L3/L4) - CiliumNetworkPolicy                    â”‚
  â”‚  - IP/Port ê¸°ë°˜ ì°¨ë‹¨                                         â”‚
  â”‚  - Namespace ê²©ë¦¬                                            â”‚
  â”‚  - eBPF ê¸°ë°˜ ê³ ì„±ëŠ¥                                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 íŠ¸ë˜í”½ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 blog-system Namespace                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [Ingress]                                                      â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”‚ :80 (all sources)                                        â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   :8080 (web only)   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚    web    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚    was    â”‚              â”‚
â”‚   â”‚  (nginx)  â”‚                      â”‚ (spring)  â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                            â”‚                     â”‚
â”‚                                            â”‚ :3306               â”‚
â”‚                                            â–¼                     â”‚
â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                                      â”‚   mysql   â”‚              â”‚
â”‚                                      â”‚           â”‚              â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                            â–²                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚                     â”‚
â”‚   â”‚   mysql-backup    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚   â”‚   (cronjob)       â”‚ :3306 (backup only)                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚             â”‚                                                    â”‚
â”‚             â”‚ :443 (S3)                                          â”‚
â”‚             â–¼                                                    â”‚
â”‚        [Internet/S3]                                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”€â”€â–¶ í—ˆìš©ëœ íŠ¸ë˜í”½
  â•³    ì°¨ë‹¨ëœ íŠ¸ë˜í”½ (ê¸°ë³¸)
```

### 3.3 ì •ì±… ìš”ì•½

**íŒŒì¼ ìœ„ì¹˜**: `/home/jimin/k8s-manifests/blog-system/cilium-netpol.yaml`

| ì •ì±… | ëŒ€ìƒ | Ingress í—ˆìš© | Egress í—ˆìš© |
|------|------|-------------|-------------|
| `mysql-isolation` | mysql | was:3306, mysql-backup:3306 | DNS |
| `was-isolation` | was | web:8080, Istio sidecar | mysql:3306, DNS, Istio |
| `web-isolation` | web | all:80, Istio sidecar | was:8080, DNS, Istio |
| `mysql-exporter-isolation` | exporter | prometheus:9104 | mysql:3306, DNS |
| `mysql-backup-isolation` | backup | - | mysql:3306, DNS, S3:443 |

### 3.4 L7 ê·œì¹™ (HTTP)

```yaml
# was-isolationì—ì„œ HTTP ë©”ì„œë“œ/ê²½ë¡œ ì œì–´
toPorts:
- ports:
  - port: "8080"
    protocol: TCP
  rules:
    http:
    - method: "GET"
      path: "/api/.*"
    - method: "POST"
      path: "/api/.*"
    - method: "PUT"
      path: "/api/.*"
    - method: "DELETE"
      path: "/api/.*"
    - method: "GET"
      path: "/actuator/.*"
```

### 3.5 ì™œ Ciliumì„ ì‚¬ìš©í–ˆëŠ”ê°€?

| ì˜µì…˜ | ì¥ì  | ë‹¨ì  | ì„ íƒ |
|------|------|------|------|
| **Cilium** | eBPF ê³ ì„±ëŠ¥, L7 ì§€ì›, Hubble ê´€ì¸¡ | í•™ìŠµ ê³¡ì„  | âœ… ì„ íƒ |
| Kubernetes NetworkPolicy | í‘œì¤€, ê°„ë‹¨ | L7 ë¯¸ì§€ì›, ê¸°ëŠ¥ ì œí•œ | âŒ |
| Calico | ì„±ìˆ™í•¨, L7 ì§€ì› | IPtables ê¸°ë°˜ | âŒ |

**ê²°ë¡ **: eBPF ê¸°ë°˜ ê³ ì„±ëŠ¥ + L7 HTTP ê·œì¹™ + Hubble ë„¤íŠ¸ì›Œí¬ ê´€ì¸¡

---

## 4. SecurityContext ì„¤ì •

### 4.1 ì ìš© í˜„í™©

| ì›Œí¬ë¡œë“œ | runAsNonRoot | allowPrivilegeEscalation | capabilities |
|----------|--------------|--------------------------|--------------|
| **was** | âœ… true (uid 1000) | âœ… false | DROP ALL |
| **web** | âŒ (nginx 80 í¬íŠ¸) | âœ… false | DROP ALL, ADD NET_BIND_SERVICE |
| **mysql** | âœ… true (uid 999) | âœ… false | DROP ALL |
| **mysql-backup** | - (ì„ì‹œ Job) | - | - |

### 4.2 WAS SecurityContext

**íŒŒì¼**: `/home/jimin/k8s-manifests/blog-system/was-rollout.yaml`

```yaml
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
      - name: spring-boot
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false  # Spring Boot ì„ì‹œ íŒŒì¼ í•„ìš”
          capabilities:
            drop: ["ALL"]
```

### 4.3 WEB (Nginx) SecurityContext

**íŒŒì¼**: `/home/jimin/k8s-manifests/blog-system/web-rollout.yaml`

```yaml
spec:
  template:
    spec:
      securityContext:
        fsGroup: 101  # nginx ê·¸ë£¹
      containers:
      - name: nginx
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
            add: ["NET_BIND_SERVICE"]  # 80 í¬íŠ¸ ë°”ì¸ë”©
```

**ì™œ runAsNonRootê°€ ì—†ëŠ”ê°€?**

nginxëŠ” 80 í¬íŠ¸ ë°”ì¸ë”©ì„ ìœ„í•´ rootë¡œ ì‹œì‘ í›„ workerë¥¼ non-rootë¡œ ì‹¤í–‰í•¨. ì™„ì „í•œ non-rootë¥¼ ìœ„í•´ì„œëŠ” `nginx-unprivileged` ì´ë¯¸ì§€ ì‚¬ìš© í•„ìš”.

### 4.4 ë³´ì•ˆ íš¨ê³¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Container Escape Prevention                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Before (ê¸°ë³¸):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Container  â”‚  root (UID 0)
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  ëª¨ë“  capabilities
  â”‚  â”‚ app   â”‚  â”‚  â†’ íƒˆì¶œ ì‹œ í˜¸ìŠ¤íŠ¸ root ê¶Œí•œ
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  After (hardened):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Container  â”‚  non-root (UID 1000)
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  capabilities DROP ALL
  â”‚  â”‚ app   â”‚  â”‚  allowPrivilegeEscalation: false
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â†’ íƒˆì¶œí•´ë„ ì¼ë°˜ ìœ ì € ê¶Œí•œ
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### 5.1 Loki Retention ì„¤ì •

**íŒŒì¼**: `/home/jimin/k8s-manifests/docs/helm/loki-stack/values.yaml`

```yaml
loki:
  config:
    table_manager:
      retention_deletes_enabled: true   # í™œì„±í™”
      retention_period: 168h            # 7ì¼
```

**íš¨ê³¼**:
- 7ì¼ ì´ìƒ ë¡œê·¸ ìë™ ì‚­ì œ
- ë””ìŠ¤í¬ ê³ ê°ˆ ë°©ì§€ (10Gi PVC)

### 5.2 ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Monitoring Architecture                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      Grafana        â”‚
                    â”‚   (Dashboards)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Prometheus  â”‚  â”‚    Loki     â”‚  â”‚   Kiali     â”‚
     â”‚  (Metrics)  â”‚  â”‚   (Logs)    â”‚  â”‚   (Mesh)    â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚                â”‚                â”‚
            â–¼                â–¼                â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Exporters  â”‚  â”‚  Promtail   â”‚  â”‚   Istio     â”‚
     â”‚  (9104)     â”‚  â”‚  (logs)     â”‚  â”‚  (envoy)    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ì•Œë¦¼ ì„¤ì •

| ë©”íŠ¸ë¦­ | ì„ê³„ê°’ | ì•Œë¦¼ ë°©ë²• |
|--------|--------|----------|
| MySQL CPU | > 80% | Grafana Alert |
| MySQL ë°±ì—… ì‹¤íŒ¨ | Job Status != Succeeded | CronJob ë¡œê·¸ í™•ì¸ |
| S3 ë°±ì—… íŒŒì¼ ì—†ìŒ | 24ì‹œê°„ ì´ìƒ | ìˆ˜ë™ í™•ì¸ í•„ìš” |

---

## 6. êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… ì™„ë£Œ í•­ëª©

- [x] MySQL ë°±ì—… CronJob ìƒì„± (S3 ì—…ë¡œë“œ)
- [x] S3 Lifecycle ì •ì±… ì„¤ì • (7ì¼ retention)
- [x] CiliumNetworkPolicy mysql-backup í—ˆìš©
- [x] Istio sidecar ì œì™¸ ì„¤ì •
- [x] emptyDirë¡œ Longhorn ì´ìŠˆ íšŒí”¼
- [x] SecurityContext ì„¤ì • (WAS, WEB)
- [x] Loki retention í™œì„±í™” (7ì¼)

### â³ ì„ íƒ í•­ëª© (P1)

- [x] Trivy ì´ë¯¸ì§€ ìŠ¤ìº” (GitHub Actions) âœ… ì™„ë£Œ (exit-code: 0, ê²½ê³ ë§Œ)
- [ ] WAS í…ŒìŠ¤íŠ¸ í™œì„±í™” (-DskipTests ì œê±°)
  - **í˜„ì¬**: Docker ë¹Œë“œ í™˜ê²½ì— MySQL ì—†ìŒ â†’ `-DskipTests` í•„ìˆ˜
  - **í•´ê²° ë°©ë²•**:
    - Testcontainers (Docker-in-Docker)
    - H2 In-Memory DB (`application-test.properties`)
  - **ì°¸ê³ **: [03-TROUBLESHOOTING.md 9.6ì ˆ](/home/jimin/blogsite/docs/03-TROUBLESHOOTING.md)
- [ ] Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ (WAS ì†ŒìŠ¤ ë³€ê²½ í•„ìš”)

### ğŸ”œ í–¥í›„ ê°œì„ 

- [ ] MySQL HA (Primary-Replica)
- [ ] S3 Cross-Region Replication (DR)
- [ ] SealedSecrets (GitOps ì‹œí¬ë¦¿ ê´€ë¦¬)

---

## íŒŒì¼ ìœ„ì¹˜ ìš”ì•½

| íŒŒì¼ | ì—­í•  |
|------|------|
| `blog-system/mysql-backup-cronjob.yaml` | MySQL ë°±ì—… CronJob |
| `blog-system/cilium-netpol.yaml` | ë„¤íŠ¸ì›Œí¬ ì •ì±… |
| `blog-system/was-rollout.yaml` | WAS SecurityContext |
| `blog-system/web-rollout.yaml` | WEB SecurityContext |
| `docs/helm/loki-stack/values.yaml` | Loki retention ì„¤ì • |

---

**ì‘ì„±ì¼**: 2026-01-22
**ì‘ì„±ì**: Claude Code
**ë‹¤ìŒ ë‹¨ê³„**: Trivy ì´ë¯¸ì§€ ìŠ¤ìº” êµ¬í˜„ (P1)
