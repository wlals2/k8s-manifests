# ==============================================================================
# Prometheus Recording Rules
# ==============================================================================
# 목적: 복잡한 PromQL 쿼리를 사전 계산하여 Dashboard 성능 개선
#
# 효과:
# - Dashboard 로딩 시간 단축 (10초 → 1초)
# - Grafana 쿼리 부하 감소
# - 일관된 메트릭 계산 방식
#
# 적용 방법:
# 1. kubectl apply -f prometheus-recording-rules.yaml
# 2. Prometheus가 자동으로 rules 로드 (rule_files: '/etc/prometheus/rules/*.yml')
# 3. Grafana에서 recording rule 사용 (예: blog_system:pod_cpu_usage:percent)
# ==============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-recording-rules
  namespace: monitoring
  labels:
    app: prometheus
data:
  recording-rules.yml: |
    groups:
      # ==============================================================================
      # Blog System - CPU & Memory Recording Rules
      # ==============================================================================
      - name: blog_system_resources
        interval: 30s
        rules:
          # CPU 사용률 (%) - Pod별
          - record: blog_system:pod_cpu_usage:percent
            expr: |
              (
                sum(rate(container_cpu_usage_seconds_total{namespace="blog-system", container!="", container!="POD"}[5m])) by (pod, container)
                /
                sum(container_spec_cpu_quota{namespace="blog-system", container!="", container!="POD"} / container_spec_cpu_period{namespace="blog-system"}) by (pod, container)
              ) * 100

          # Memory 사용률 (%) - Pod별
          - record: blog_system:pod_memory_usage:percent
            expr: |
              (
                sum(container_memory_working_set_bytes{namespace="blog-system", container!="", container!="POD"}) by (pod, container)
                /
                sum(container_spec_memory_limit_bytes{namespace="blog-system", container!="", container!="POD"}) by (pod, container)
              ) * 100

          # CPU 사용량 (cores) - Pod별
          - record: blog_system:pod_cpu_usage:cores
            expr: |
              sum(rate(container_cpu_usage_seconds_total{namespace="blog-system", container!="", container!="POD"}[5m])) by (pod, container)

          # Memory 사용량 (bytes) - Pod별
          - record: blog_system:pod_memory_usage:bytes
            expr: |
              sum(container_memory_working_set_bytes{namespace="blog-system", container!="", container!="POD"}) by (pod, container)

      # ==============================================================================
      # Blog System - Application Metrics Recording Rules
      # ==============================================================================
      - name: blog_system_application
        interval: 30s
        rules:
          # Nginx Request Rate (req/s) - Pod별
          - record: blog_system:nginx_request_rate:per_second
            expr: |
              sum(rate(nginx_http_requests_total{namespace="blog-system"}[5m])) by (pod, status)

          # Nginx Error Rate (%) - 5xx errors
          - record: blog_system:nginx_error_rate:percent
            expr: |
              (
                sum(rate(nginx_http_requests_total{namespace="blog-system", status=~"5.."}[5m]))
                /
                sum(rate(nginx_http_requests_total{namespace="blog-system"}[5m]))
              ) * 100

          # MySQL Connection Count
          - record: blog_system:mysql_connections:current
            expr: |
              mysql_global_status_threads_connected{namespace="blog-system"}

          # MySQL Query Rate (queries/s)
          - record: blog_system:mysql_query_rate:per_second
            expr: |
              rate(mysql_global_status_queries{namespace="blog-system"}[5m])

          # MySQL Slow Query Rate (queries/s)
          - record: blog_system:mysql_slow_query_rate:per_second
            expr: |
              rate(mysql_global_status_slow_queries{namespace="blog-system"}[5m])

      # ==============================================================================
      # Blog System - Pod Status Recording Rules
      # ==============================================================================
      - name: blog_system_availability
        interval: 15s
        rules:
          # Pod Running Count - app별
          - record: blog_system:pod_running:count
            expr: |
              sum(kube_pod_status_phase{namespace="blog-system", phase="Running"}) by (pod, phase)

          # Pod Ready Count - app별
          - record: blog_system:pod_ready:count
            expr: |
              sum(kube_pod_status_ready{namespace="blog-system", condition="true"}) by (pod)

          # Pod Restart Count (5분 동안)
          - record: blog_system:pod_restart_rate:5m
            expr: |
              rate(kube_pod_container_status_restarts_total{namespace="blog-system"}[5m]) * 300

      # ==============================================================================
      # Monitoring Namespace - Self Monitoring Recording Rules
      # ==============================================================================
      - name: monitoring_system
        interval: 30s
        rules:
          # Prometheus CPU 사용률
          - record: monitoring:prometheus_cpu_usage:percent
            expr: |
              (
                sum(rate(container_cpu_usage_seconds_total{namespace="monitoring", pod=~"prometheus.*"}[5m]))
                /
                sum(container_spec_cpu_quota{namespace="monitoring", pod=~"prometheus.*"} / container_spec_cpu_period{namespace="monitoring"})
              ) * 100

          # Prometheus Memory 사용률
          - record: monitoring:prometheus_memory_usage:percent
            expr: |
              (
                sum(container_memory_working_set_bytes{namespace="monitoring", pod=~"prometheus.*"})
                /
                sum(container_spec_memory_limit_bytes{namespace="monitoring", pod=~"prometheus.*"})
              ) * 100

          # Grafana CPU 사용률
          - record: monitoring:grafana_cpu_usage:percent
            expr: |
              (
                sum(rate(container_cpu_usage_seconds_total{namespace="monitoring", pod=~"grafana.*"}[5m]))
                /
                sum(container_spec_cpu_quota{namespace="monitoring", pod=~"grafana.*"} / container_spec_cpu_period{namespace="monitoring"})
              ) * 100

          # Loki CPU 사용률
          - record: monitoring:loki_cpu_usage:percent
            expr: |
              (
                sum(rate(container_cpu_usage_seconds_total{namespace="monitoring", pod=~"loki.*"}[5m]))
                /
                sum(container_spec_cpu_quota{namespace="monitoring", pod=~"loki.*"} / container_spec_cpu_period{namespace="monitoring"})
              ) * 100

          # Tempo CPU 사용률
          - record: monitoring:tempo_cpu_usage:percent
            expr: |
              (
                sum(rate(container_cpu_usage_seconds_total{namespace="monitoring", pod=~"tempo.*"}[5m]))
                /
                sum(container_spec_cpu_quota{namespace="monitoring", pod=~"tempo.*"} / container_spec_cpu_period{namespace="monitoring"})
              ) * 100
