# Prometheus Adapter Values
# Custom Metrics API 제공 (HPA에서 Istio 메트릭 사용)

prometheus:
  url: http://prometheus.monitoring.svc.cluster.local
  port: 9090

rules:
  default: false  # 기본 규칙 비활성화 (직접 정의)

  custom:
  # ==============================================================================
  # Container Network Receive Rate (초당 받는 바이트 수)
  # ==============================================================================
  # WEB Pod의 네트워크 트래픽을 측정하여 부하 추정
  # - HTTP 요청이 많을수록 네트워크 트래픽 증가
  # - interface="eth0": 메인 네트워크 인터페이스
  # - namespace/pod 별로 그룹화
  - seriesQuery: 'container_network_receive_bytes_total{namespace="blog-system",pod=~"web.*",interface="eth0"}'
    resources:
      overrides:
        namespace: {resource: "namespace"}
        pod: {resource: "pod"}
    name:
      matches: "^(.*)_total$"
      as: "${1}_per_second"
    metricsQuery: |
      sum(rate(<<.Series>>{<<.LabelMatchers>>,interface="eth0"}[1m])) by (<<.GroupBy>>)

  # ==============================================================================
  # Container Network Transmit Rate (초당 보내는 바이트 수)
  # ==============================================================================
  # WEB Pod의 응답 트래픽 측정
  - seriesQuery: 'container_network_transmit_bytes_total{namespace="blog-system",pod=~"web.*",interface="eth0"}'
    resources:
      overrides:
        namespace: {resource: "namespace"}
        pod: {resource: "pod"}
    name:
      matches: "^(.*)_total$"
      as: "${1}_per_second"
    metricsQuery: |
      sum(rate(<<.Series>>{<<.LabelMatchers>>,interface="eth0"}[1m])) by (<<.GroupBy>>)

# Resource requests
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 256Mi

# Replica count
replicas: 1

# Node affinity (monitoring namespace)
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - prometheus-adapter
        topologyKey: kubernetes.io/hostname
